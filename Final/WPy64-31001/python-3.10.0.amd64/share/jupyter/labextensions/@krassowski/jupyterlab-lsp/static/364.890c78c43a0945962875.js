(self.webpackChunk_krassowski_jupyterlab_lsp=self.webpackChunk_krassowski_jupyterlab_lsp||[]).push([[364],{4988:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,".lsp-floating-console {\n  position: absolute;\n  width: 600px;\n  min-height: 350px;\n  height: 25%;\n  right: 0;\n  bottom: 0;\n  background: rgba(255, 255, 255, 0.8);\n  border: 3px solid rgba(204, 204, 204, 0.7);\n  font-size: 12px;\n  overflow-y: auto;\n  margin: 0;\n  list-style-type: none;\n  padding: 5px;\n  z-index: 100;\n}\n\n.lsp-code {\n  font-family: monospace;\n  background: #eee;\n  border-radius: 2px;\n  padding: 2px 5px;\n}\n\n.lsp-kind {\n  padding: 2px 5px;\n}\n",""]);const o=s},2372:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,".lsp-diagnostics-panel-content {\n  overflow-y: auto;\n}\n\n.lsp-diagnostics-listing {\n  color: var(--jp-ui-font-color1);\n  background: var(--jp-layout-color1);\n  font-size: var(--jp-ui-font-size1);\n  border-spacing: 0;\n  width: 100%;\n}\n\n.lsp-diagnostics-listing thead {\n  box-shadow: var(--jp-toolbar-box-shadow);\n}\n\n.lsp-diagnostics-listing tbody {\n  overflow-y: auto;\n  overflow-x: hidden;\n}\n\n.lsp-diagnostics-listing th,\n.lsp-diagnostics-listing td {\n  padding: 4px 12px 2px 12px;\n  height: 18px;\n}\n\n.lsp-diagnostics-listing th {\n  font-weight: 500;\n  text-align: left;\n  border-bottom: var(--jp-border-width) solid var(--jp-border-color1);\n  background: var(--jp-layout-color1);\n  position: sticky;\n  top: 0;\n  z-index: 2;\n  white-space: nowrap;\n  user-select: none;\n}\n\n.lsp-diagnostics-listing th:not(:first-child) {\n  border-left: var(--jp-border-width) solid var(--jp-border-color2);\n}\n\n.lsp-diagnostics-listing th:hover {\n  background: var(--jp-layout-color2);\n}\n\n.lsp-diagnostics-listing tbody tr:hover {\n  background: var(--jp-layout-color2);\n}\n\n.lsp-diagnostics-listing thead th > div {\n  flex-direction: row;\n  display: flex;\n}\n\n.lsp-diagnostics-listing thead th > div > label {\n  flex: 1;\n  text-overflow: ellipsis;\n}\n\n.lsp-sort-icon {\n  flex: 0;\n  height: var(--jp-ui-font-size1);\n  width: var(--jp-ui-font-size1);\n}\n\n.lsp-sort-icon svg {\n  display: inline;\n  height: auto;\n}\n\n.lsp-diagnostics-listing thead th:not(.lsp-sorted-header) .lsp-sort-icon {\n  opacity: 0;\n}\n\n.lsp-diagnostics-listing thead th:not(.lsp-sorted-header):hover .lsp-sort-icon {\n  opacity: 0.5;\n}\n",""]);const o=s},3075:(e,t,n)=>{"use strict";n.d(t,{Z:()=>d});var i=n(2609),s=n.n(i),o=n(8996),r=n(6801),a=n(2361),l=n(6143),c=s()((function(e){return e[1]}));c.i(o.Z),c.i(r.Z),c.i(a.Z),c.i(l.Z),c.push([e.id,'.cm-lsp-diagnostic {\n  text-decoration-line: underline;\n  /* For Chrome */\n  text-decoration-skip-ink: none;\n}\n\n.cm-lsp-diagnostic-Error {\n  /*\n    "wavy" would be ideal, but there seems to be a bug in Chrome which makes it\n    fail to render the last character see:\n    https://stackoverflow.com/questions/57559588/how-to-make-the-wavy-underline-extend-cover-all-the-characters-in-chrome\n    an alternative would be to use background image trick to simulate the underline\n  */\n\n  text-decoration-style: var(\n    --jp-editor-mirror-lsp-diagnostic-decoration-style\n  );\n  text-decoration-color: var(\n    --jp-editor-mirror-lsp-diagnostic-error-decoration-color\n  );\n}\n\n.cm-lsp-diagnostic-Warning {\n  text-decoration-style: var(\n    --jp-editor-mirror-lsp-diagnostic-decoration-style\n  );\n  text-decoration-color: var(\n    --jp-editor-mirror-lsp-diagnostic-warning-decoration-color\n  );\n}\n\n.cm-lsp-diagnostic-Information {\n  text-decoration-style: var(\n    --jp-editor-mirror-lsp-diagnostic-decoration-style\n  );\n  text-decoration-color: var(\n    --jp-editor-mirror-lsp-diagnostic-information-decoration-color\n  );\n}\n\n.cm-lsp-diagnostic-Hint {\n  text-decoration-style: var(\n    --jp-editor-mirror-lsp-diagnostic-decoration-style\n  );\n  text-decoration-color: var(\n    --jp-editor-mirror-lsp-diagnostic-hint-decoration-color\n  );\n}\n\n/* hover */\n.cm-lsp-hover-available {\n  text-decoration: var(--jp-editor-mirror-lsp-hover-decoration-style);\n  text-decoration-color: var(--jp-editor-mirror-lsp-hover-decoration-color);\n  text-decoration-line: underline;\n  text-decoration-skip-ink: none;\n}\n\n/* highlight */\n.cm-lsp-highlight {\n  background-color: var(--jp-editor-mirror-lsp-highlight-background-color);\n}\n',""]);const d=c},4599:(e,t,n)=>{"use strict";n.d(t,{Z:()=>c});var i=n(2609),s=n.n(i),o=n(3075),r=n(9538),a=n(4302),l=s()((function(e){return e[1]}));l.i(o.Z),l.i(r.Z),l.i(a.Z),l.push([e.id,".lsp-document-locator:hover {\n  cursor: pointer;\n}\n\n.lsp-document-locator span:not(:last-child)::after {\n  content: ' > ';\n}\n\n.lsp-icon-flip-x {\n  transform: scaleX(-1);\n  transform-origin: center center;\n}\n\n.lsp-external-link {\n  color: var(--jp-content-link-color);\n}\n",""]);const c=l},4302:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,".lsp-signature-help pre code {\n  font-size: var(--jp-code-font-size);\n}\n",""]);const o=s},4929:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,".lsp-popover {\n  /* jupyterlab Menu */\n  z-index: 10000;\n  padding: 4px 0px;\n  background: var(--jp-layout-color0);\n  color: var(--jp-ui-font-color1);\n  border: var(--jp-border-width) solid var(--jp-border-color1);\n  font-size: var(--jp-ui-font-size1);\n  box-shadow: var(--jp-elevation-z6);\n}\n\n.lsp-popover-content {\n  padding: 5px 10px;\n}\n\n.lsp-servers-title {\n  margin-bottom: 5px;\n}\n\n.lsp-servers-menu {\n  height: 350px;\n  overflow-y: auto;\n}\n\n.lsp-server-status,\n.lsp-missing-server,\n.lsp-documents-by-language {\n  margin-left: 20px;\n}\n\nh5 .lsp-language-server-name {\n  color: var(--jp-ui-font-color2);\n}\n\n.lsp-documents-by-language ul,\n.lsp-server-status ul {\n  margin: 0;\n  padding-left: 25px;\n}\n\n.lsp-servers-menu h5 {\n  font-weight: normal;\n  font-size: 100%;\n  white-space: nowrap;\n}\n\n.lsp-servers-lists {\n  margin-left: 5px;\n}\n\n.lsp-popover-status {\n  padding-top: 5px;\n  border-top: 1px solid var(--jp-border-color1);\n}\n\n.lsp-popover-status a {\n  color: var(--jp-content-link-color);\n}\n\n.lsp-servers-menu h3,\nh4,\nh5 {\n  margin: 0;\n}\n\n.lsp-documents-by-language li {\n  width: 100%;\n  display: flex;\n  justify-content: space-between;\n}\n\n.lsp-document-status {\n  float: right;\n  padding-left: 15px;\n}\n\n.lsp-document-status-icon {\n  margin-left: 5px;\n  position: relative;\n  top: 3px;\n}\n\n.lsp-collapsible-list h4 {\n  cursor: pointer;\n}\n\n.lsp-collapsible-list .lsp-caret-icon {\n  position: relative;\n  top: 3px;\n}\n\n.lsp-collapsible-list.lsp-collapsed div {\n  display: none;\n}\n\n.lsp-statusbar-item {\n  overflow: hidden;\n  white-space: nowrap;\n}\n\n.lsp-status-icon.ready svg g {\n  fill: var(--jp-success-color0);\n}\n\n.lsp-status-icon.preparing svg g {\n  fill: var(--jp-warn-color0);\n}\n\n.lsp-status-icon.error svg g {\n  fill: var(--jp-error-color0);\n}\n\n.lsp-status-icon.inactive svg g {\n  fill: var(--jp-layout-color3);\n}\n\n.lsp-status-message {\n  user-select: none;\n}\n\nbody[data-jp-theme-light='false'] .lsp-status-icon.ready svg g {\n  fill: var(--jp-success-color1);\n}\n\n.lsp-statusbar-item.jp-mod-selected .jp-icon-selectable[fill] {\n  fill: #fff;\n}\n\n.jp-ToolbarButton .lsp-status-icon svg {\n  top: 5px;\n}\n\n.lsp-help-button {\n  background: var(--jp-layout-color2);\n  border: 1px solid var(--jp-brand-color0);\n  float: right;\n}\n\n.lsp-help-button:hover {\n  background: var(--jp-layout-color3);\n}\n\n.lsp-server-links-list a {\n  color: var(--jp-content-link-color);\n}\n\n.lsp-troubleshoot-section {\n  white-space: pre-wrap;\n  margin: 10px 0;\n}\n",""]);const o=s},9538:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,".lsp-tooltip .jp-RenderedHTMLCommon {\n  /* Reduce the default padding from 20px to 0px */\n  padding-right: 0px;\n}\n\n.lsp-tooltip .jp-RenderedHTMLCommon > *:last-child {\n  /* Reduce the default margin */\n  margin-bottom: 0;\n}\n",""]);const o=s},8996:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,":root {\n  /* highlight */\n  --jp-editor-mirror-lsp-highlight-background-color: var(--jp-layout-color2);\n  /* diagnostics */\n  --jp-editor-mirror-lsp-diagnostic-decoration-style: dashed;\n  --jp-editor-mirror-lsp-diagnostic-error-decoration-color: var(\n    --jp-error-color1\n  );\n  --jp-editor-mirror-lsp-diagnostic-warning-decoration-color: var(\n    --jp-warn-color1\n  );\n  --jp-editor-mirror-lsp-diagnostic-information-decoration-color: var(\n    --jp-info-color1\n  );\n  --jp-editor-mirror-lsp-diagnostic-hint-decoration-color: var(\n    --jp-success-color1\n  );\n  /* hover */\n  --jp-editor-mirror-lsp-hover-decoration-style: dotted;\n  --jp-editor-mirror-lsp-hover-decoration-color: var(--jp-brand-color1);\n}\n",""]);const o=s},6801:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,".cm-s-abcdef {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(144, 199, 255, 0.2);\n}\n\n.cm-s-base16-dark {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n\n.cm-s-base16-light {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(186, 192, 161, 0.1);\n}\n\n.cm-s-default {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n\n.cm-s-hopscotch {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(207, 18, 255, 0.2);\n}\n\n.cm-s-material {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 255, 58, 0.2);\n}\n\n.cm-s-mbo {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n\n.cm-s-material {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n\n.cm-s-mdn-like {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n\n.cm-s-seti {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n\n.cm-s-solarized {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n\n.cm-s-the-matrix {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.1);\n}\n\n.cm-s-xq-light {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n\n.cm-s-zenburn {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n",""]);const o=s},2361:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,"body[data-jp-theme-light='false'] .cm-s-jupyter {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(151, 173, 255, 0.3);\n}\n",""]);const o=s},6143:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,"body[data-jp-theme-light='true'] .cm-s-jupyter {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n",""]);const o=s},5384:(e,t,n)=>{"use strict";n.d(t,{wo:()=>s,Uu:()=>r,OC:()=>a,kZ:()=>l});var i=n(1797);const s="lsp-completer-theme-";var o;!function(e){e[e.Text=1]="Text",e[e.Method=2]="Method",e[e.Function=3]="Function",e[e.Constructor=4]="Constructor",e[e.Field=5]="Field",e[e.Variable=6]="Variable",e[e.Class=7]="Class",e[e.Interface=8]="Interface",e[e.Module=9]="Module",e[e.Property=10]="Property",e[e.Unit=11]="Unit",e[e.Value=12]="Value",e[e.Enum=13]="Enum",e[e.Keyword=14]="Keyword",e[e.Snippet=15]="Snippet",e[e.Color=16]="Color",e[e.File=17]="File",e[e.Reference=18]="Reference",e[e.Folder=19]="Folder",e[e.EnumMember=20]="EnumMember",e[e.Constant=21]="Constant",e[e.Struct=22]="Struct",e[e.Event=23]="Event",e[e.Operator=24]="Operator",e[e.TypeParameter=25]="TypeParameter"}(o||(o={}));const r="@krassowski/completion-manager",a="Kernel",l=new i.Token(r+":ILSPCompletionThemeManager")},4364:(e,t,n)=>{"use strict";n.r(t),n.d(t,{FeatureManager:()=>Jn,ILSPAdapterManager:()=>a,ILSPCodeExtractorsManager:()=>c,ILSPCodeOverridesManager:()=>m,ILSPFeatureManager:()=>r,ILSPLogConsole:()=>d,ILSPVirtualEditorManager:()=>l,ILanguageServerManager:()=>i,LSPExtension:()=>Gn,PLUGIN_ID:()=>o,RegExpForeignCodeExtractor:()=>p,default:()=>Qn});var i,s=n(1797);!function(e){e.URL_NS="lsp"}(i||(i={}));const o="@krassowski/jupyterlab-lsp",r=new s.Token(o+":ILSPFeatureManager"),a=new s.Token(o+":ILSPAdapterManager"),l=new s.Token(o+":ILSPVirtualEditorManager"),c=new s.Token(o+":ILSPCodeExtractorsManager"),d=new s.Token(o+":ILSPLogConsole");function h(e,t){return t&&e.line===t.line&&e.ch===t.ch}function u(e,t){let n=0,i=0;for(let s of t){if(!(s.length+1<=e)){i=e;break}e-=s.length+1,n+=1}return{line:n,column:i}}function _(e,t,n=!1){let i=n?0:1,s=0;for(let n=0;n<t.length;n++){let o=t[n];if(!(e.line>n)){s+=e.column;break}s+=o.length+i}return s}function g(e,t,n){let i=e.exec(t),s=0,o=i[0];for(let e of i.slice(1)){if(void 0===e)continue;if(e===n){s+=o.indexOf(e);break}let t=o.indexOf(e)+e.length;o=o.slice(t),s+=t}return s}class p{constructor(e){this.language=e.language,this.options=e,this.global_expression=new RegExp(e.pattern,"g"),this.test_expression=new RegExp(e.pattern,"g"),this.expression=new RegExp(e.pattern),this.standalone=this.options.is_standalone,this.file_extension=this.options.file_extension}has_foreign_code(e){let t=this.test_expression.test(e);return this.test_expression.lastIndex=0,t}extract_foreign_code(e){let t,n,i=e.split("\n"),s=new Array,o=this.global_expression.lastIndex,r=this.global_expression.exec(e),a=!1;for(void 0!==this.options.foreign_replacer?(n=this.options.foreign_replacer,a=!0):void 0!==this.options.foreign_capture_groups?(n="$"+this.options.foreign_capture_groups.join("$"),a=!0):n=this.options.extract_to_foreign;null!=r;){let l=r[0],c=null,d=l.replace(this.expression,n),h="";void 0!==this.options.extract_arguments&&(h=l.replace(this.expression,this.options.extract_arguments),c=u(h.length,h.split("\n")));let _=this.global_expression.lastIndex;t=this.options.keep_in_host||null==this.options.keep_in_host?e.substring(o,_):o===r.index?"":e.substring(o,r.index)+"\n";let p=d;a&&(p=l.replace(this.expression,"$"+Math.min(...this.options.foreign_capture_groups)));const m=g(this.expression,l,p);let v=r.index+m,f=u(v,i),w=u(v+d.length,i);s.push({host_code:t,foreign_code:h+d,range:{start:f,end:w},virtual_shift:c}),o=this.global_expression.lastIndex,r=this.global_expression.exec(e)}if(o!==e.length){let t=e.substring(o,e.length);s.push({host_code:t,foreign_code:null,range:null,virtual_shift:null})}return s}}const m=new s.Token(o+":ILSPCodeOverridesManager");var v=n(9938),f=n(4835),w=n(6310),y=n(2310),b=n(4337),x=n(3224),k=n(242),C=n(7849),S=n(2230),E=n(8077),M=n(6168),j=n(6062),I=n.n(j),T=n(4599);I()(T.Z,{insert:"head",singleton:!1}),T.Z.locals;class L{constructor(e){this.shell=e,this.adapters=new Map,this.adapterChanged=new M.Signal(this),this.adapterDisposed=new M.Signal(this),this.adapterTypeAdded=new M.Signal(this),this.adapterTypes=[],e.currentChanged.connect(this.refreshAdapterFromCurrentWidget,this)}get types(){return this.adapterTypes}registerAdapterType(e){this.adapterTypes.push(e),this.adapterTypeAdded.emit(e)}connect(e,t){t.tracker.widgetAdded.connect(((n,i)=>{this.connectWidget(e,i,t)})),e.registerAdapterType(this,t)}registerExtension(e){for(let t of this.adapterTypes)this.connect(e,t);this.adapterTypeAdded.connect(((t,n)=>{this.connect(e,n)}))}connectWidget(e,t,n){let i=new n.adapter(e,t);this.registerAdapter({adapter:i,id:n.get_id(t),re_connector:()=>{this.connectWidget(e,t,n)}}),this.refreshAdapterFromCurrentWidget()}refreshAdapterFromCurrentWidget(){const e=this.shell.currentWidget;if(!e)return;let t=null;for(let n of this.adapterTypes)if(n.tracker.has(e)){let i=n.get_id(e);t=this.adapters.get(i)}null!=t&&(this.currentAdapter=t,this.adapterChanged.emit(t))}registerAdapter(e){let{id:t,adapter:n,re_connector:i}=e,s=e.adapter.widget;if(this.adapters.has(t)){let e=this.adapters.get(t);console.warn(`Adapter with id ${t} was already registered (${n} vs ${e}) `)}this.adapters.set(t,n);const o=()=>{this.adapters.delete(t),s.disposed.disconnect(o),s.context.pathChanged.disconnect(r),n.dispose()},r=()=>{o(),i()};s.disposed.connect((()=>{o(),this.adapterDisposed.emit(n)})),s.context.pathChanged.connect(r),this.refreshAdapterFromCurrentWidget()}isAnyActive(){return this.shell.currentWidget&&this.adapterTypes.some((e=>e.tracker.currentWidget))&&this.adapterTypes.some((e=>e.tracker.currentWidget==this.shell.currentWidget))}}const R={id:o+":ILSPAdapterManager",activate:e=>{let t=e.shell;return new L(t)},provides:a,autoStart:!0};var A=n(8256);class P{static lsp_to_cm(e){return{line:e.line,ch:e.character}}static cm_to_lsp(e){return{line:e.line,character:e.ch}}static lsp_to_ce(e){return{line:e.line,column:e.character}}static cm_to_ce(e){return{line:e.line,column:e.ch}}static ce_to_cm(e){return{line:e.line,ch:e.column}}}var D,O=n(249),z=n(6988);class ${constructor(e){this.on_new_connection=e=>{e.on("error",(t=>{this.console.warn(t);let n=t.length&&t.length>=1?t[0]:new Error;-1!==n.message.indexOf("code = 1005")?(this.console.warn("Connection failed for "+e),this.forEachDocumentOfConnection(e,(t=>{this.console.warn("disconnecting "+t.uri),this.closed.emit({connection:e,virtual_document:t}),this.ignored_languages.add(t.language),this.console.warn(`Cancelling further attempts to connect ${t.uri} and other documents for this language (no support from the server)`)}))):-1!==n.message.indexOf("code = 1006")?this.console.warn("Connection closed by the server"):this.console.error("Connection error:",t)})),e.on("serverInitialized",(t=>{this.forEachDocumentOfConnection(e,(t=>{this.initialized.emit({connection:e,virtual_document:t})})),this.updateServerConfigurations(this.initial_configurations)})),e.on("close",(t=>{t?(this.console.warn("Connection closed"),this.forEachDocumentOfConnection(e,(t=>{this.closed.emit({connection:e,virtual_document:t})}))):this.console.warn("Connection unexpectedly disconnected")}))},this.connections=new Map,this.documents=new Map,this.ignored_languages=new Set,this.connected=new M.Signal(this),this.initialized=new M.Signal(this),this.disconnected=new M.Signal(this),this.closed=new M.Signal(this),this.documents_changed=new M.Signal(this),this.language_server_manager=e.language_server_manager,this.console=e.console,D.setLanguageServerManager(e.language_server_manager)}connect_document_signals(e){e.foreign_document_opened.connect(this.on_foreign_document_opened,this),e.foreign_document_closed.connect(this.on_foreign_document_closed,this),this.documents.set(e.uri,e),this.documents_changed.emit(this.documents)}disconnect_document_signals(e,t=!0){e.foreign_document_opened.disconnect(this.on_foreign_document_opened,this),e.foreign_document_closed.disconnect(this.on_foreign_document_closed,this),this.documents.delete(e.uri);for(const t of e.foreign_documents.values())this.disconnect_document_signals(t,!1);t&&this.documents_changed.emit(this.documents)}on_foreign_document_opened(e,t){this.console.log("ConnectionManager received foreign document: ",t.foreign_document.uri)}on_foreign_document_closed(e,t){const{foreign_document:n}=t;this.disconnect_document_signals(n)}async connect_socket(e){this.console.log("Connection Socket",e);let{virtual_document:t,language:n}=e;this.connect_document_signals(t);const i=$.solve_uris(t,n),s=this.language_server_manager.getMatchingServers({language:n});this.console.debug("Matching servers: ",s);const o=0===s.length?null:s[0],r=await D.connection(n,o,i,this.on_new_connection,this.console);return this.connections.set(t.uri,r),r}updateConfiguration(e){this.language_server_manager.setConfiguration(e)}updateServerConfigurations(e){let t;for(t in e){if(!e.hasOwnProperty(t))continue;const n=e[t],i={settings:(0,z.HY)(n.serverSettings)};this.console.log("Server Update: ",t),this.console.log("Sending settings: ",i),D.updateServerConfiguration(t,i)}}forEachDocumentOfConnection(e,t){for(const[n,i]of this.connections.entries())e===i&&t(this.documents.get(n))}async retry_to_connect(e,t,n=-1){let{virtual_document:i}=e;if(this.ignored_languages.has(i.language))return;let s=1e3*t,o=!1;for(;0!==n&&!o;)await this.connect(e).then((()=>{o=!0})).catch((e=>{this.console.warn(e)})),this.console.log("will attempt to re-connect in "+s/1e3+" seconds"),await(0,z._v)(s),s=s<5e3?s+500:s}async connect(e,t=30,n=5){this.console.log("connection requested",e);let i=await this.connect_socket(e),{virtual_document:s,document_path:o}=e;if(!i.isReady)try{await(0,z.EU)((()=>i.isReady),Math.round(1e3*t/150),150)}catch(e){this.console.warn(`Connection to ${s.uri} timed out after ${t} seconds, will continue retrying for another ${n} minutes`);try{await(0,z.EU)((()=>i.isReady),60*n,1e3)}catch(e){return void this.console.warn(`Connection to ${s.uri} timed out again after ${n} minutes, giving up`)}}return this.console.log(o,s.uri,"connected."),this.connected.emit({connection:i,virtual_document:s}),i}unregister_document(e){this.connections.delete(e.uri),this.documents_changed.emit(this.documents)}updateLogging(e,t){for(const n of this.connections.values())n.logAllCommunication=e,null!==t&&n.clientNotifications["$/setTrace"].emit({value:t})}}!function(e){e.solve_uris=function(e,t){const n=O.PageConfig.getBaseUrl().replace(/^http/,"ws"),s=O.PageConfig.getOption("rootUri"),o=O.PageConfig.getOption("virtualDocumentsUri"),r=e.has_lsp_supported_file?s:o,a=D.getLanguageServerManager().getMatchingServers({language:t}),l=0===a.length?null:a[0];if(null===l)throw"No language server installed for language "+t;let c=O.URLExt.join(r,e.uri);return!c.startsWith("file:///")&&c.startsWith("file://")&&(c=c.replace("file://","file:///"),c.startsWith("file:///users/")&&r.startsWith("file:///Users/")&&(c=c.replace("file:///users/","file:///Users/"))),{base:r,document:c,server:O.URLExt.join("ws://jupyter-lsp",t),socket:O.URLExt.join(n,i.URL_NS,"ws",l)}}}($||($={})),function(e){const t=new Map;let i,s;e.getLanguageServerManager=function(){return s},e.setLanguageServerManager=function(e){s=e},e.connection=async function(e,s,o,r,a){null==i&&(i=n.e(16).then(n.bind(n,7811)));const{LSPConnection:l}=await i;let c=t.get(s);if(null==c){const n=new WebSocket(o.socket),i=new l({languageId:e,serverUri:o.server,rootUri:o.base,serverIdentifier:s,console:a});i.setMaxListeners(999),t.set(s,i),i.connect(n),r(i)}return c=t.get(s),c},e.updateServerConfiguration=function(e,n){const i=t.get(e);i&&i.sendConfigurationChange(n)}}(D||(D={}));class H extends Map{constructor(e){super(e.map((e=>[new RegExp(e.pattern),e.replacement])))}_override_for(e){for(let[t,n]of this)if(e.match(t))return e.replace(t,n);return null}}class q extends H{constructor(e){super(e),this.overrides=e}get reverse(){return this.type(this.overrides.map((e=>e.reverse)))}type(e){return new q(e)}override_for(e){return super._override_for(e)}replace_all(e,t=this){let n=new Array,i=new Array;for(let s=0;s<e.length;s++){let o=e[s],r=t.override_for(o);n.push(null==r?o:r),i.push(null!=r)}return{lines:n,skip_inspect:i}}reverse_replace_all(e){return this.replace_all(e,this.reverse).lines}}var F=n(4988);function N(e){return e.map((e=>{let t;if("string"==typeof e)return e;try{t=JSON.stringify({k:e}).slice(5,-1)}catch(n){t=""+e}return'<span class="lsp-code">'+t+"</span>"})).join(" ")}I()(F.Z,{insert:"head",singleton:!1}),F.Z.locals;class W{constructor(e=["LSP"],t=null){t?this.element=t:(this.element=document.createElement("ul"),this.element.className="lsp-floating-console",document.body.appendChild(this.element))}bindThis(){return this}dispose(){this.element.remove()}append(e,t="log"){let n=document.createElement("li");n.innerHTML='<span class="lsp-kind">'+t+"</span>"+e,this.element.appendChild(n),this.element.scrollTop=this.element.scrollHeight}debug(...e){this.append(N(e),"debug")}log(...e){this.append(N(e),"log")}warn(...e){this.append(N(e),"warn")}error(...e){this.append(N(e),"error")}}class V{constructor(){this.debug=window.console.debug.bind(window.console),this.log=window.console.log.bind(window.console),this.warn=window.console.warn.bind(window.console),this.error=window.console.error.bind(window.console)}dispose(){}scope(e){return this}bindThis(){return window.console}}class U{constructor(e=["LSP"],t){this.breadcrumbs=e,this._scope=this.breadcrumbs.join(".")+":",this.singleton=t,this.singleton.changed.connect(this._rebind_functions.bind(this)),this._rebind_functions()}_rebind_functions(){const e=()=>{},t=this.implementation.bindThis();"debug"===this.verbosity?this.debug=this.implementation.debug.bind(t,this._scope):this.debug=e,"debug"===this.verbosity||"log"===this.verbosity?this.log=this.implementation.log.bind(t,this._scope):this.log=e,"debug"===this.verbosity||"log"===this.verbosity||"warn"===this.verbosity?this.warn=this.implementation.warn.bind(t,this._scope):this.warn=e,this.error=this.implementation.error.bind(t,this._scope)}get verbosity(){return this.singleton.verbosity}get implementation(){return this.singleton.implementation}debug(...e){return this.implementation.debug(this._scope,...e)}log(...e){return this.implementation.log(this._scope,...e)}warn(...e){return this.implementation.warn(this._scope,...e)}error(...e){return this.implementation.error(this._scope,...e)}scope(e){return new U([...this.breadcrumbs,e],this.singleton)}}class B{constructor(e){this.verbosity="debug",this.implementation=new V,this.changed=new M.Signal(this),e.load(o+":plugin").then((e=>{this.updateSettings(e),e.changed.connect((()=>{this.updateSettings(e)}))})).catch(console.warn)}updateSettings(e){const t=e.composite,n=t.loggingConsole;this.implementation&&this.implementation.dispose(),"browser"===n?this.implementation=new V:"floating"===n?this.implementation=new W:(console.warn("Unknown console type",n,"falling back to browser console"),this.implementation=new V),this.verbosity=t.loggingLevel,this.changed.emit()}}const Z={id:o+":ILSPLogConsole",requires:[b.ISettingRegistry],activate:(e,t)=>{const n=new B(t);return new U(["LSP"],n)},provides:d,autoStart:!0};function K(e,t){return t.start.line===t.end.line?e.line===t.start.line&&e.column>=t.start.column&&e.column<=t.end.column:e.line===t.start.line&&e.column>=t.start.column&&e.line<t.end.line||e.line>t.start.line&&e.column<=t.end.column&&e.line===t.end.line||e.line>t.start.line&&e.line<t.end.line}class J{constructor(e){this.version=0,this._document=e}get text(){return this._document.value}get uri(){return $.solve_uris(this._document,this.languageId).document}get languageId(){return this._document.language}}class G{constructor(e){this.isDisposed=!1,this.blank_lines_between_cells=2,this.options=e,this.path=e.path,this.console=e.console,this.file_extension=e.file_extension,this.has_lsp_supported_file=e.has_lsp_supported_file,this.parent=e.parent,this.language=e.language;let t=this.language in e.overrides_registry?e.overrides_registry[this.language]:null;this.cell_magics_overrides=new q(t?t.cell:[]),this.line_magics_overrides=new q(t?t.line:[]),this.foreign_extractors_registry=e.foreign_code_extractors,this.foreign_extractors=this.language in this.foreign_extractors_registry?this.foreign_extractors_registry[this.language]:[],this.virtual_lines=new Map,this.source_lines=new Map,this.foreign_documents=new Map,this.overrides_registry=e.overrides_registry,this.standalone=e.standalone,this.instance_id=G.instances_count,G.instances_count+=1,this.unused_standalone_documents=new z.Gl((()=>new Array)),this._remaining_lifetime=6,this.foreign_document_closed=new M.Signal(this),this.foreign_document_opened=new M.Signal(this),this.changed=new M.Signal(this),this.unused_documents=new Set,this.document_info=new J(this),this.update_manager=new Y(this,e.console),this.clear()}dispose(){if(!this.isDisposed){this.isDisposed=!0,this.parent=null;for(const e of this.foreign_documents.values())e.dispose();this.close_all_foreign_documents(),this.update_manager.dispose(),this.foreign_documents.clear(),this.source_lines.clear(),this.unused_documents.clear(),this.unused_standalone_documents.clear(),this.virtual_lines.clear(),this.cell_magics_overrides=null,this.document_info=null,this.foreign_extractors=null,this.foreign_extractors_registry=null,this.line_magics_overrides=null,this.line_blocks=null,this.overrides_registry=null}}get remaining_lifetime(){return this.parent?this._remaining_lifetime:1/0}set remaining_lifetime(e){this.parent&&(this._remaining_lifetime=e)}clear(){this.unused_standalone_documents.clear();for(let e of this.foreign_documents.values())e.clear(),e.standalone&&this.unused_standalone_documents.get(e.language).push(e);this.unused_documents=new Set(this.foreign_documents.values()),this.virtual_lines.clear(),this.source_lines.clear(),this.last_virtual_line=0,this.last_source_line=0,this.line_blocks=[]}forward_closed_signal(e,t){this.foreign_document_closed.emit(t)}forward_opened_signal(e,t){this.foreign_document_opened.emit(t)}open_foreign(e,t,n){let i=new G(Object.assign(Object.assign({},this.options),{parent:this,standalone:t,file_extension:n,language:e}));const s={foreign_document:i,parent_host:this};return this.foreign_document_opened.emit(s),i.foreign_document_closed.connect(this.forward_closed_signal,this),i.foreign_document_opened.connect(this.forward_opened_signal,this),this.foreign_documents.set(i.virtual_id,i),i}document_at_source_position(e){let t=this.source_lines.get(e.line);if(null==t)return this;let n={line:t.editor_line,column:e.ch};for(let[e,{virtual_document:i}]of t.foreign_documents_map)if(K(n,e)){let t={line:n.line-e.start.line,ch:n.column-e.start.column};return i.document_at_source_position(t)}return this}is_within_foreign(e){let t=this.source_lines.get(e.line),n={line:t.editor_line,column:e.ch};for(let[e]of t.foreign_documents_map)if(K(n,e))return!0;return!1}virtual_position_at_document(e){let t=this.source_lines.get(e.line),n=t.virtual_line,i={line:t.editor_line,column:e.ch};for(let[e,{virtual_line:n,virtual_document:s}]of t.foreign_documents_map)if(K(i,e)){let t={line:i.line-e.start.line,ch:i.column-e.start.column};return s.is_within_foreign(t)?this.virtual_position_at_document(t):(t.line+=n,t)}return{ch:e.ch,line:n}}choose_foreign_document(e){let t,n=this.foreign_documents.has(e.language);if(!e.standalone&&n)t=this.foreign_documents.get(e.language),this.unused_documents.delete(t);else{let n=this.unused_standalone_documents.get(e.language);e.standalone&&n.length>0?(t=n.pop(),this.unused_documents.delete(t)):t=this.open_foreign(e.language,e.standalone,e.file_extension)}return t}extract_foreign_code(e,t){let n=new Map,i=e.value;for(let s of this.foreign_extractors){if(!s.has_foreign_code(i))continue;let o=s.extract_foreign_code(i),r="";for(let i of o){if(null!==i.foreign_code){let o=this.choose_foreign_document(s);n.set(i.range,{virtual_line:o.last_virtual_line,virtual_document:o,editor:e.ce_editor});let r={line:t.line+i.range.start.line,column:t.column+i.range.start.column};o.append_code_block({value:i.foreign_code,ce_editor:e.ce_editor},r,i.virtual_shift)}null!=i.host_code&&(r+=i.host_code)}i=r}return{cell_code_kept:i,foreign_document_map:n}}decode_code_block(e){let t=this.cell_magics_overrides.reverse.override_for(e);return null!=t?t:this.line_magics_overrides.reverse_replace_all(e.split("\n")).join("\n")}prepare_code_block(e,t={line:0,column:0}){let n,i,{cell_code_kept:s,foreign_document_map:o}=this.extract_foreign_code(e,t),r=s,a=this.cell_magics_overrides.override_for(r);if(null!=a)n=a.split("\n"),i=n.map((e=>[this.id_path]));else{let e=this.line_magics_overrides.replace_all(r.split("\n"));n=e.lines,i=e.skip_inspect.map((e=>e?[this.id_path]:[]))}return{lines:n,foreign_document_map:o,skip_inspect:i}}get foreign_document_maps(){let e=new Set;for(let t of this.source_lines.values())e.add(t.foreign_documents_map);return[...e.values()]}append_code_block(e,t={line:0,column:0},n){let i=e.value,s=e.ce_editor;if(this.isDisposed)return void console.warn("Cannot append code block: document disposed");let o=i.split("\n"),{lines:r,foreign_document_map:a,skip_inspect:l}=this.prepare_code_block(e,t);for(let e=0;e<r.length;e++)this.virtual_lines.set(this.last_virtual_line+e,{skip_inspect:l[e],editor:s,source_line:this.last_source_line+e});for(let e=0;e<o.length;e++)this.source_lines.set(this.last_source_line+e,{editor_line:e,editor_shift:{line:t.line-((null==n?void 0:n.line)||0),column:0===e?t.column-((null==n?void 0:n.column)||0):0},editor:s,foreign_documents_map:a,virtual_line:this.last_virtual_line+e});this.last_virtual_line+=r.length,this.line_blocks.push(r.join("\n")+"\n");for(let e=0;e<this.blank_lines_between_cells;e++)this.virtual_lines.set(this.last_virtual_line+e,{skip_inspect:[this.id_path],editor:s,source_line:null});this.last_virtual_line+=this.blank_lines_between_cells,this.last_source_line+=o.length}get value(){let e="\n".repeat(this.blank_lines_between_cells);return this.line_blocks.join(e)}get last_line(){const e=this.line_blocks[this.line_blocks.length-1].split("\n");return e[e.length-1]}close_expired_documents(){for(let e of this.unused_documents.values())e.remaining_lifetime-=1,e.remaining_lifetime<=0&&this.close_foreign(e)}close_foreign(e){console.log("LSP: closing document",e),this.foreign_document_closed.emit({foreign_document:e,parent_host:this}),this.foreign_documents.delete(e.virtual_id),e.close_all_foreign_documents(),e.foreign_document_closed.disconnect(this.forward_closed_signal,this),e.foreign_document_opened.disconnect(this.forward_opened_signal,this)}close_all_foreign_documents(){for(let e of this.foreign_documents.values())this.close_foreign(e)}get virtual_id(){return this.standalone?this.instance_id+"("+this.language+")":this.language}get ancestry(){return this.parent?this.parent.ancestry.concat([this]):[this]}get id_path(){return this.parent?this.parent.id_path+"-"+this.virtual_id:this.virtual_id}get uri(){const e=encodeURI(this.path);return this.parent?e+"."+this.id_path+"."+this.file_extension:e}transform_source_to_editor(e){if(null==e)return void this.console.warn("no position available");let t=this.source_lines.get(e.line),n=t.editor_line,i=t.editor_shift;return{ch:e.ch+(0===n?i.column:0),line:n+i.line}}transform_virtual_to_editor(e){let t=this.transform_virtual_to_source(e);return this.transform_source_to_editor(t)}transform_virtual_to_source(e){return{ch:e.ch,line:this.virtual_lines.get(e.line).source_line}}get root(){return null==this.parent?this:this.parent.root}get_editor_at_virtual_line(e){if(null==e)return void this.console.warn("no position available");let t=e.line;return this.virtual_lines.has(t)||(t-=1),this.virtual_lines.get(t).editor}get_editor_at_source_line(e){if(null!=e)return this.source_lines.get(e.line).editor;this.console.warn("no position available")}maybe_emit_changed(){this.value!==this.previous_value&&this.changed.emit(this),this.previous_value=this.value;for(let e of this.foreign_documents.values())e.maybe_emit_changed()}}function X(e){let t=new Set;t.add(e);for(let n of e.foreign_documents.values())X(n).forEach(t.add,t);return t}G.instances_count=0;class Y{constructor(e,t){this.virtual_document=e,this.is_update_in_progress=!1,this.update_lock=!1,this.isDisposed=!1,this.update_done=new Promise((e=>{e()})),this.document_updated=new M.Signal(this),this.block_added=new M.Signal(this),this.update_began=new M.Signal(this),this.update_finished=new M.Signal(this),this.document_updated.connect(this.on_updated,this),this.console=t||new V}dispose(){this.isDisposed||this.document_updated.disconnect(this.on_updated,this)}on_updated(e,t){try{t.close_expired_documents()}catch(e){this.console.warn("Failed to close expired documents")}}can_update(){return!this.isDisposed&&!this.is_update_in_progress&&!this.update_lock}async with_update_lock(e){await(0,z.EU)((()=>this.can_update()),12,10).then((()=>{try{this.update_lock=!0,e()}finally{this.update_lock=!1}}))}async update_documents(e){let t=new Promise((async(t,n)=>{await(0,z.EU)((()=>this.can_update()),10,5).then((()=>{!this.isDisposed&&this.virtual_document||t();try{this.is_update_in_progress=!0,this.update_began.emit(e),this.virtual_document.clear();for(let t of e)this.block_added.emit({block:t,virtual_document:this.virtual_document}),this.virtual_document.append_code_block(t);this.update_finished.emit(e),this.virtual_document&&(this.document_updated.emit(this.virtual_document),this.virtual_document.maybe_emit_changed()),t()}catch(e){this.console.warn("Documents update failed:",e),n(e)}finally{this.is_update_in_progress=!1}}))}));return this.update_done=t,t}}class Q{constructor(e,t,n=new Array,i){this.editor=e,this.virtual_document=t,this.isDisposed=!1,this.editor.change.connect(this.saveChange,this),this.console=i.scope("EditorAdapter"),this.features=new Map;for(let e of n)e.register(),e.is_registered||this.console.warn("The feature ",e,"was not registered properly"),this.features.set(e.feature.id,e)}async updateAfterChange(){try{await(0,z.EU)((()=>null!=this.last_change),30,22)}catch(e){return void this.console.log("No change obtained from CodeMirror editor within the expected time of 0.66s")}let e,t=this.last_change;try{e=this.editor.get_cursor_position()}catch(e){return void this.console.log("Root position not found")}try{let n=this.editor.document_at_root_position(e);if(this.virtual_document!==n)return!0;if(!t||!t.text.length||!t.text[0].length)return!0;for(let n of this.features.values())try{n.afterChange(t,e)}catch(e){console.warn("afterChange of feature",n,"failed with",e)}return!0}catch(e){this.console.log("updateAfterChange failure"),this.console.error(e)}this.invalidateLastChange()}invalidateLastChange(){this.last_change=null}saveChange(e,t){this.last_change=t}dispose(){if(!this.isDisposed){for(let e of this.features.values())e.remove();this.features.clear(),this.editor.change.disconnect(this.saveChange),this.editor=null,this.isDisposed=!0}}}var ee=f.Dialog.createButton;class te{constructor(){this.message="",this.changed=new M.Signal(this),this.timer=null}set(e,t=3e3){this.expire_timer(),this.message=e,this.changed.emit(),-1!==t&&(this.timer=window.setTimeout(this.clear.bind(this),t))}clear(){this.message="",this.changed.emit()}expire_timer(){null!==this.timer&&(window.clearTimeout(this.timer),this.timer=0)}}const ne={"text/x-rsrc":"r","text/x-r-source":"r","text/x-ipython":"python"};class ie{constructor(e,t){this.extension=e,this.widget=t,this.isDisposed=!1,this.app=e.app,this.connection_manager=e.connection_manager,this.adapterConnected=new M.Signal(this),this.activeEditorChanged=new M.Signal(this),this.editorRemoved=new M.Signal(this),this.editorAdded=new M.Signal(this),this.adapters=new Map,this.status_message=new te,this.isConnected=!1,this.console=e.console.scope("WidgetAdapter"),this.trans=(e.translator||k.nullTranslator).load("jupyterlab-lsp"),this.widget.context.saveState.connect(this.on_save_state,this),this.connection_manager.closed.connect(this.on_connection_closed,this),this.widget.disposed.connect(this.dispose,this)}get foreign_code_extractors(){return this.extension.foreign_code_extractors}get code_overrides(){return this.extension.code_overrides}on_connection_closed(e,{virtual_document:t}){var n;this.console.log("connection closed, disconnecting adapter",t.id_path),t===(null===(n=this.virtual_editor)||void 0===n?void 0:n.virtual_document)&&this.dispose()}dispose(){var e,t;this.isDisposed||((null===(e=this.virtual_editor)||void 0===e?void 0:e.virtual_document)&&this.disconnect_adapter(null===(t=this.virtual_editor)||void 0===t?void 0:t.virtual_document),this.widget.context.saveState.disconnect(this.on_save_state,this),this.connection_manager.closed.disconnect(this.on_connection_closed,this),this.widget.disposed.disconnect(this.dispose,this),this.disconnect(),this.virtual_editor=null,this.app=null,this.widget=null,this.connection_manager=null,this.widget=null,this.isDisposed=!0)}get widget_id(){return this.widget.id}get language(){if(ne.hasOwnProperty(this.mime_type))return ne[this.mime_type];{let e=this.mime_type.split(";")[0],[t,n]=e.split("/");return"application"===t||"text"===t?n.startsWith("x-")?n.substr(2):n:this.mime_type}}disconnect(){this.connection_manager.unregister_document(this.virtual_editor.virtual_document),this.widget.context.model.contentChanged.disconnect(this.onContentChanged,this);for(let e of this.editors)this.editorRemoved.emit({editor:e});for(let e of this.adapters.values())e.dispose();this.adapters.clear(),this.virtual_editor.dispose()}reload_connection(){null!=this.virtual_editor&&(this.disconnect(),this.init_virtual(),this.connect_document(this.virtual_editor.virtual_document,!0).catch(this.console.warn))}on_save_state(e,t){if(null!=this.virtual_editor&&("completed"===t||"completed manually"===t)){const e=[this.virtual_editor.virtual_document];for(let t of e){let n=this.connection_manager.connections.get(t.uri);this.console.log("Sending save notification for",t.uri,"to",n),n.sendSaved(t.document_info);for(let n of t.foreign_documents.values())e.push(n)}}}update_documents(){if(!this.isDisposed)return this.virtual_editor.virtual_document.update_manager.update_documents(this.editors.map((e=>({ce_editor:e,value:this.virtual_editor.get_editor_value(e)}))));this.console.warn("Cannot update documents: adapter disposed")}get has_multiple_editors(){return this.editors.length>1}async on_connected(e){let{virtual_document:t}=e;this.connect_adapter(e.virtual_document,e.connection),this.adapterConnected.emit(e),this.isConnected=!0,await this.update_documents().then((()=>{this.document_changed(t,t,!0),this.console.log("virtual document(s) for",this.document_path,"have been initialized")}));const n=t.uri,i=this.extension.user_console.getLogger(n);e.connection.serverNotifications["$/logTrace"].connect(((n,i)=>{this.console.log(e.connection.serverIdentifier,"trace",t.uri,i)})),e.connection.serverNotifications["window/logMessage"].connect(((n,s)=>{this.console.log(e.connection.serverIdentifier,t.uri,s),i.log({type:"text",data:n.serverIdentifier+": "+s.message})})),e.connection.serverNotifications["window/showMessage"].connect(((n,i)=>{this.console.log(e.connection.serverIdentifier,t.uri,i.message),(0,f.showDialog)({title:this.trans.__("Message from ")+n.serverIdentifier,body:i.message})})),e.connection.serverRequests["window/showMessageRequest"].setHandler((async n=>{this.console.log(e.connection.serverIdentifier,t.uri,n);const i=n.actions,s=i.map((e=>ee({label:e.title}))),o=await(0,f.showDialog)({title:this.trans.__("Message from ")+e.connection.serverIdentifier,body:n.message,buttons:s}),r=s.indexOf(o.button);if(-1!==r)return i[r]}))}async connect_document(e,t=!1){e.changed.connect(this.document_changed,this),e.foreign_document_opened.connect(this.on_foreign_document_opened,this);const n=await this.connect(e).catch(this.console.warn);t&&(n&&n.connection?n.connection.sendOpenWhenReady(e.document_info):this.console.warn(`Connection for ${e.path} was not opened`))}create_virtual_editor(e){let t=this.extension.editor_type_manager.findBestImplementation(this.editors);return null==t?null:new(0,t.implementation)(e)}init_virtual(){let e=this.create_virtual_editor({adapter:this,virtual_document:this.create_virtual_document()});null!=e?(this.virtual_editor=e,this.connect_contentChanged_signal()):this.console.error("Could not initialize a VirtualEditor for adapter: ",this)}async on_foreign_document_opened(e,t){const{foreign_document:n}=t;await this.connect_document(n,!0),n.foreign_document_closed.connect(this.on_foreign_document_closed,this)}on_foreign_document_closed(e,t){const{foreign_document:n}=t;n.foreign_document_closed.disconnect(this.on_foreign_document_closed,this),n.foreign_document_opened.disconnect(this.on_foreign_document_opened,this),n.changed.disconnect(this.document_changed,this)}document_changed(e,t,n=!1){if(this.isDisposed)return void this.console.warn("Cannot swap document: adapter disposed");let i=this.connection_manager.connections.get(e.uri),s=this.adapters.get(e.id_path);(null==i?void 0:i.isReady)?null!=s?(i.sendFullTextChange(e.value,e.document_info),n||this.virtual_editor.virtual_document.update_manager.with_update_lock((async()=>{await s.updateAfterChange()})).then().catch(this.console.warn)):this.console.log("Skipping document update signal: adapter not ready"):this.console.log("Skipping document update signal: connection not ready")}connect_adapter(e,t,n=null){let i=this.create_adapter(e,t,n);return this.adapters.set(e.id_path,i),i}disconnect_adapter(e){let t=this.adapters.get(e.id_path);this.adapters.delete(e.id_path),null!=t&&t.dispose()}get_features(e){let t=this.adapters.get(e.id_path);return null==t?void 0:t.features}async connect(e){let t=e.language;this.console.log("will connect using language: "+t);let n={virtual_document:e,language:t,document_path:this.document_path},i=await this.connection_manager.connect(n);return await this.on_connected({virtual_document:e,connection:i}),{connection:i,virtual_document:e}}connect_contentChanged_signal(){this.widget.context.model.contentChanged.connect(this.onContentChanged,this)}create_adapter(e,t,n=null){let i=new Array;null===n&&(n=this.extension.feature_manager.features);for(let s of n){let n=new(s.editorIntegrationFactory.get(this.virtual_editor.editor_name))({feature:s,virtual_editor:this.virtual_editor,virtual_document:e,connection:t,status_message:this.status_message,settings:s.settings,adapter:this,trans:this.trans});i.push(n)}let s=new Q(this.virtual_editor,e,i,this.console);return this.console.log("Adapter for",this.document_path,"is ready."),t.sendOpenWhenReady(e.document_info),s}async onContentChanged(e){this.update_finished=this.update_documents().catch(this.console.warn),await this.update_finished}get_position_from_context_menu(){let e=this.app.contextMenuHitTest((()=>!0)),{left:t,top:n}=e.getBoundingClientRect(),i=this.app._contextMenuEvent;return void 0!==i&&(t=i.clientX,n=i.clientY,i.stopPropagation()),this.virtual_editor.window_coords_to_root_position({left:t,top:n})}get_context(e){let t=this.virtual_editor.document_at_root_position(e),n=this.virtual_editor.root_position_to_virtual_position(e);return{document:t,connection:this.connection_manager.connections.get(t.uri),virtual_position:n,root_position:e,features:this.get_features(t),editor:this.virtual_editor,app:this.app,adapter:this}}get_context_from_context_menu(){let e=this.get_position_from_context_menu();return this.get_context(e)}}class se extends ie{constructor(e,t){super(e,t),this.editor=t.content,this.initialized=new Promise(((e,t)=>{this.init_once_ready().then(e).catch(t)}))}get document_path(){return this.widget.context.path}get mime_type(){const e=this.editor.model.mimeType,t=this.editor.context.contentsModel;return"text/plain"!=e?e:t?this.extension.app.docRegistry.getFileTypeForModel(this.editor.context.contentsModel).mimeTypes[0]:e}get language_file_extension(){let e=this.document_path.split(".");return e[e.length-1]}get ce_editor(){return this.editor.editor}get activeEditor(){return this.editor.editor}async init_once_ready(){this.editor.context.isReady||await this.editor.context.ready,this.init_virtual(),this.console.log("file ready for connection:",this.path),this.connect_document(this.virtual_editor.virtual_document,!1).catch(this.console.warn),this.editor.model.mimeTypeChanged.connect(this.reload_connection,this)}get_editor_index(e){return 0}get_editor_wrapper(e){return this.wrapper_element}get wrapper_element(){return this.widget.node}get path(){return this.widget.context.path}context_from_active_document(){let e=this.widget.content.editor.getCursorPosition(),t=P.ce_to_cm(e);return null==this?void 0:this.get_context(t)}get_editor_index_at(e){return 0}get editors(){return[this.editor.editor]}create_virtual_document(){return new G({language:this.language,file_extension:this.language_file_extension,path:this.document_path,overrides_registry:{},foreign_code_extractors:{},standalone:!0,has_lsp_supported_file:!0,console:this.console})}}const oe={id:o+":FileEditorAdapter",requires:[a],optional:[A.IEditorTracker],activate(e,t,n){null===n?console.warn("LSP: no fileEditorTracker - not registering file editor capabilities"):t.registerAdapterType({name:"file_editor",tracker:n,adapter:se,entrypoint:"file-editor-context-menu",get_id:e=>e.id,context_menu:{selector:".jp-FileEditor",rank_group:0,rank_group_size:4}})},autoStart:!0};var re=n(2575);class ae extends ie{constructor(e,t){super(e,t),this.type="code",this.is_ready=()=>{var e;return!this.widget.isDisposed&&this.widget.context.isReady&&this.widget.content.isVisible&&this.widget.content.widgets.length>0&&null!=(null===(e=this.widget.context.sessionContext.session)||void 0===e?void 0:e.kernel)},this.ce_editor_to_cell=new Map,this.editor=t.content,this.known_editors_ids=new Set,this.initialized=new Promise(((e,t)=>{this.init_once_ready().then(e).catch(t)}))}async update_language_info(){this._language_info=(await this.widget.context.sessionContext.session.kernel.info).language_info}async on_kernel_changed(e,t){if(t.newValue)try{await this.update_language_info(),this.console.log(`Changed to ${this._language_info.name} kernel, reconnecting`),await(0,z.EU)(this.is_ready,-1),this.reload_connection()}catch(e){this.console.warn(e),this.reload_connection()}else this.console.log("kernel was shut down")}dispose(){this.isDisposed||(this.widget.context.sessionContext.kernelChanged.disconnect(this.on_kernel_changed,this),this.widget.content.activeCellChanged.disconnect(this.activeCellChanged,this),super.dispose(),this.ce_editor_to_cell.clear())}get document_path(){return this.widget.context.path}language_info(){return this._language_info}get mime_type(){let e=this.language_info();return e?e.mimetype:this.widget.content.codeMimetype}get language_file_extension(){let e=this.language_info();return e?e.file_extension.replace(".",""):null}get wrapper_element(){return this.widget.node}async init_once_ready(){this.console.log("waiting for",this.document_path,"to fully load"),await this.widget.context.sessionContext.ready,await(0,z.EU)(this.is_ready,-1),await this.update_language_info(),this.console.log(this.document_path,"ready for connection"),this.init_virtual(),this.connect_document(this.virtual_editor.virtual_document,!1).catch(this.console.warn),this.widget.context.sessionContext.kernelChanged.connect(this.on_kernel_changed,this),this.widget.content.activeCellChanged.connect(this.activeCellChanged,this),this.widget.model.cells.changed.connect(this.handle_cell_change,this),this.editor.modelChanged.connect((e=>{this.console.warn("Model changed, connecting cell change handler; this is not something we were expecting"),e.model.cells.changed.connect(this.handle_cell_change,this)}))}async handle_cell_change(e,t){let n=[],i=[];const s=this.type;if("set"===t.type){let e=[],o=[];if(t.newValues.length===t.oldValues.length){for(let n=0;n<t.newValues.length;n++)t.oldValues[n].type===s&&t.newValues[n].type!==s?e.push(t.newValues[n]):t.oldValues[n].type!==s&&t.newValues[n].type===s&&o.push(t.newValues[n]);n=o,i=e}}else"add"==t.type&&(n=t.newValues.filter((e=>e.type===s)));(i.length||n.length||"move"===t.type||"remove"===t.type)&&await this.update_documents();for(let e of i){let t=this.widget.content.widgets.find((t=>t.model.id===e.id));this.known_editors_ids.delete(t.editor.uuid),this.editorRemoved.emit({editor:t.editor})}for(let e of n){let t=this.widget.content.widgets.find((t=>t.model.id===e.id));this.known_editors_ids.add(t.editor.uuid),this.editorAdded.emit({editor:t.editor})}}get editors(){if(this.isDisposed)return;let e=this.widget.content;return this.ce_editor_to_cell.clear(),e.isDisposed?[]:e.widgets.filter((e=>"code"===e.model.type)).map((e=>(this.ce_editor_to_cell.set(e.editor,e),e.editor)))}create_virtual_document(){return new G({language:this.language,path:this.document_path,overrides_registry:this.code_overrides,foreign_code_extractors:this.foreign_code_extractors,file_extension:this.language_file_extension,standalone:!1,has_lsp_supported_file:!1,console:this.console})}get activeEditor(){return this.widget.content.activeCell.editor}activeCellChanged(e,t){t.model.type===this.type&&(this.known_editors_ids.has(t.editor.uuid)||(this.known_editors_ids.add(t.editor.uuid),this.editorAdded.emit({editor:t.editor})),this.activeEditorChanged.emit({editor:t.editor}))}context_from_active_document(){let e=this.widget.content.activeCell;if(e.model.type!==this.type)return null;let t=e.editor,n=t.getCursorPosition(),i=P.ce_to_cm(n),s=null==this?void 0:this.virtual_editor;if(null==s)return null;let o=s.transform_from_editor_to_root(t,i);return null==o?(this.console.warn("Could not retrieve current context",s),null):null==this?void 0:this.get_context(o)}get_editor_index_at(e){let t=this.get_cell_at(e);return this.widget.content.widgets.findIndex((e=>t===e))}get_editor_index(e){let t=this.ce_editor_to_cell.get(e);return this.widget.content.widgets.findIndex((e=>t===e))}get_editor_wrapper(e){return this.ce_editor_to_cell.get(e).node}get_cell_at(e){let t=this.virtual_editor.virtual_document.get_editor_at_virtual_line(e);return this.ce_editor_to_cell.get(t)}}const le={id:o+":NotebookAdapter",requires:[a,re.INotebookTracker],activate(e,t,n){t.registerAdapterType({name:"notebook",tracker:n,adapter:ae,entrypoint:"notebook-cell-context-menu",get_id:e=>e.content.id,context_menu:{selector:".jp-Notebook .jp-CodeCell .jp-Editor",rank_group:10+Number.EPSILON,rank_group_size:4,callback(e){e.add_context_separator(0)}}})},autoStart:!0};class ce extends class{constructor(e){this.add_to_palette=!0,this.category="Language Server Protocol",this.adapter_manager=e.adapter_manager,this.app=e.app,this.palette=e.palette,this.tracker=e.tracker,this.suffix=e.suffix,this.entry_point=e.entry_point}get current_adapter(){return this.adapter_manager.currentAdapter}add(e){for(let t of e){let e=this.create_id(t);this.app.commands.addCommand(e,{execute:()=>this.execute(t),isEnabled:()=>this.is_enabled(t),isVisible:()=>this.is_visible(t),label:t.label,icon:t.icon}),this.should_attach(t)&&this.attach_command(t),this.add_to_palette&&this.palette.addItem({command:e,category:this.category})}}should_attach(e){return null==e.attach_to||e.attach_to.has(this.entry_point)}create_id(e){return"lsp:"+e.id+"-"+this.suffix}}{constructor(e){super(e),this.selector=e.selector,this.entry_point=e.entry_point,this.rank_group=e.rank_group,this.rank_group_size=e.rank_group_size,this.console=e.console,e.callback&&e.callback(this)}attach_command(e){this.app.contextMenu.addItem({selector:this.selector,command:this.create_id(e),rank:this.get_rank(e)})}add_context_separator(e){this.app.contextMenu.addItem({type:"separator",selector:this.selector,rank:this.rank_group+e})}execute(e){let t=this.get_context();t&&e.execute(t)}get is_context_menu_open(){return this.app.contextMenu.menu.isAttached}get is_widget_current(){return null!=this.tracker.currentWidget&&this.tracker.currentWidget===this.app.shell.currentWidget}is_enabled(){return this.is_context_menu_open?function(e){let t=e.get_position_from_context_menu();return!!t&&""!==e.virtual_editor.get_token_at(t).value}(this.current_adapter):this.is_widget_current}get_context(){var e;let t=null;if(this.is_context_menu_open)try{t=this.current_adapter.get_context_from_context_menu()}catch(e){this.console.warn("contextMenu is attached, but could not get the context",e),t=null}return null==t&&(t=null===(e=this.current_adapter)||void 0===e?void 0:e.context_from_active_document()),t}is_visible(e){var t;try{let n=this.get_context();return null!=n&&this.current_adapter&&(null===(t=n.connection)||void 0===t?void 0:t.isReady)&&e.is_enabled(n)}catch(e){return this.console.warn("is_visible failed",e),!1}}get_rank(e){if((void 0===e.is_rank_relative||e.is_rank_relative)&&void 0!==this.rank_group&&this.rank_group_size){let t=void 0!==e.rank?e.rank:0;return this.rank_group+t/this.rank_group_size}return null!=e.rank?e.rank:1/0}}var de=n(8936),he=n(6271),ue=n.n(he),_e=n(4929);function ge(e,t){return ue().createElement("a",{href:e,target:"_blank",rel:"noopener noreferrer",className:"lsp-external-link"},t)}I()(_e.Z,{insert:"head",singleton:!1}),_e.Z.locals;const pe=ue().createElement("div",null,ue().createElement("p",null,"It appears that the required Jupyter server extension (",ue().createElement("code",null,"jupyter-lsp"),") is not installed (or not enabled) in this environment."),ue().createElement("h3",null,"What are the likely reasons?"),ue().createElement("ul",null,ue().createElement("li",null,"It might be that you just installed it and need to restart JupyterLab to make it available on startup."),ue().createElement("li",null,"Alternatively, you may be using an older ",ue().createElement("code",null,"notebook")," server instead of the new ",ue().createElement("code",null,"jupyter_server"),"; please refer to the"," ",ge("https://jupyter-server.readthedocs.io/en/latest/operators/migrate-from-nbserver.html","migration guide")," or if you are a JupyterHub user please ensure that you start the JupyterLab using"," ",ue().createElement("code",null,"jupyter_server")," and not the old ",ue().createElement("code",null,"notebook"),", as documented in"," ",ge("https://github.com/jupyterhub/jupyterhub/pull/3329/files","this pull request"),"."),ue().createElement("li",null,"There may be schema errors or language server errors preventing the extension from loading - please check the logs of JupyterLab (in the console where you execute ",ue().createElement("code",null,"jupyter lab"))),ue().createElement("h3",null,"How do I check if the extension is installed?"),ue().createElement("p",null,"Please ensure that ",ue().createElement("code",null,"jupyter server extension list")," includes jupyter-lsp and that it is enabled. If it is enabled please try to restart JupyterLab. If the server extension is installed but not enabled and all other suggestions listed above failed try the following:",ue().createElement("code",null,"jupyter server extension enable --user --py jupyter_lsp"))),me=new de.LabIcon({name:"lsp:codeWarning",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M6.59 3.41L2 8l4.59 4.6L8 11.18 4.82 8 8 4.82 6.59 3.41m5.82 0L11 4.82 14.18 8 11 11.18l1.41 1.42L17 8l-4.59-4.59M16.95 12.05L10.9 22.5H23m-6.05-8.25l4.141 7.15h-8.283m3.592-4.95v2.2h1.1v-2.2m-1.1 3.3v1.1h1.1v-1.1"/>\n  </g>\n</svg>\n'}),ve=new de.LabIcon({name:"lsp:codeClock",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M6.59 3.41L2 8l4.59 4.6L8 11.18 4.82 8 8 4.82 6.59 3.41m5.82 0L11 4.82 14.18 8 11 11.18l1.41 1.42L17 8l-4.59-4.59M18.093 21.608a3.998 3.998 0 004.015-4.015 3.998 3.998 0 00-4.015-4.016 3.998 3.998 0 00-4.016 4.016 3.998 3.998 0 004.016 4.015m0-8.923c2.676 0 4.907 2.23 4.907 4.908 0 2.676-2.23 4.907-4.907 4.907s-4.908-2.23-4.908-4.907 2.23-4.908 4.908-4.908m2.498 5.89l-.348.624-2.588-1.428v-2.632h.75v2.141z" />\n  </g>\n</svg>\n'}),fe=new de.LabIcon({name:"lsp:codeCheck",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M6.59,3.41L2,8L6.59,12.6L8,11.18L4.82,8L8,4.82L6.59,3.41M12.41,3.41L11,4.82L14.18,8L11,11.18L12.41,12.6L17,8L12.41,3.41M21.59,11.59L13.5,19.68L9.83,16L8.42,17.41L13.5,22.5L23,13L21.59,11.59Z" />\n  </g>\n</svg>\n'});function we(e){e&&(e.scrollIntoView(),e.focus())}function ye(e){let{document:t,adapter:n}=e,i=null;if(n.has_multiple_editors){let e=t.virtual_lines.get(0);e?i=n.get_editor_wrapper(e.editor):console.warn("Could not get first line of ",t)}let s=function(e,t,n,i=!0){return n||(n=k.nullTranslator.load("")),e.ancestry.map((e=>{if(!e.parent){let t=e.path;!e.has_lsp_supported_file&&t.endsWith(e.file_extension)&&(t=t.slice(0,-e.file_extension.length-1));const n=t;if(i){let e=t.split("/");e.length>2&&(t=e[0]+"/.../"+e[e.length-1])}return ue().createElement("span",{key:e.uri,title:n},t)}if(!e.virtual_lines.size)return ue().createElement("span",{key:e.uri},"Empty document");try{if(t.has_multiple_editors){let i=e.virtual_lines.get(0),s=e.virtual_lines.get(e.last_virtual_line-1),o=t.get_editor_index(i.editor),r=t.get_editor_index(s.editor),a=o===r?n.__("cell %1",o+1):n.__("cells: %1-%2",o+1,r+1);return ue().createElement("span",{key:e.uri},e.language," (",a,")")}}catch(e){console.warn("LSP: could not display document cell location",e)}return ue().createElement("span",{key:e.uri},e.language)}))}(t,n,e.trans);return ue().createElement("div",{className:"lsp-document-locator",onClick:()=>we(i||null)},s)}var be=f.Dialog.okButton;function xe(e){let t=e.server.spec.languages.map(((e,t)=>ue().createElement("li",{key:t},e)));return ue().createElement("div",{className:"lsp-server-status"},ue().createElement("h5",null,e.server.spec.display_name),ue().createElement("ul",null,t))}class ke extends ue().Component{constructor(e){super(e),this.handleClick=()=>{this.setState((e=>({isCollapsed:!e.isCollapsed})))},this.state={isCollapsed:e.startCollapsed||!1}}render(){const e=this.state.isCollapsed?de.caretDownIcon:de.caretUpIcon;return ue().createElement("div",{className:"lsp-collapsible-list "+(this.state.isCollapsed?"lsp-collapsed":"")},ue().createElement("h4",{onClick:this.handleClick},ue().createElement(e.react,{tag:"span",className:"lsp-caret-icon"}),this.props.title,": ",this.props.list.length),ue().createElement("div",null,this.props.list))}}class Ce extends ue().Component{render(){const e=this.props.specs,t=this.props.trans;return ue().createElement("div",null,ue().createElement("h3",null,e.display_name),ue().createElement("div",null,ue().createElement("ul",{className:"lsp-server-links-list"},Object.entries((null==e?void 0:e.urls)||{}).map((([e,t])=>ue().createElement("li",{key:this.props.serverId+"-url-"+e},e,":"," ",ue().createElement("a",{href:t,target:"_blank",rel:"noreferrer"},t))))),ue().createElement("h4",null,t.__("Troubleshooting")),ue().createElement("p",{className:"lsp-troubleshoot-section"},e.troubleshoot?e.troubleshoot:t.__("In case of issues with installation feel welcome to ask a question on GitHub.")),ue().createElement("h4",null,t.__("Installation")),ue().createElement("ul",null,(null==e?void 0:e.install)?Object.entries((null==e?void 0:e.install)||{}).map((([e,t])=>ue().createElement("li",{key:this.props.serverId+"-install-"+e},e,": ",ue().createElement("code",null,t)))):t.__("No installation instructions were provided with this specification."))))}}class Se extends ue().Component{constructor(){super(...arguments),this.handleClick=()=>{const e=this.props.trans;(0,f.showDialog)({title:e.__("No language server for %1 detected",this.props.language),body:ue().createElement("div",null,this.props.servers.size?ue().createElement("div",null,ue().createElement("p",null,e._n("There is %1 language server you can easily install that supports %2.","There are %1 language servers you can easily install that supports %2.",this.props.servers.size,this.props.language)),[...this.props.servers.entries()].map((([t,n])=>ue().createElement(Ce,{specs:n,serverId:t,key:t,trans:e})))):ue().createElement("div",null,ue().createElement("p",null,e.__("We do not have an auto-detection ready for a language servers supporting %1 yet.",this.props.language)),ue().createElement("p",null,e.__("You may contribute a specification for auto-detection as described in our ")," ",ue().createElement("a",{href:"https://jupyterlab-lsp.readthedocs.io/en/latest/Contributing.html#specs"},e.__("documentation"))))),buttons:[be()]}).catch(console.warn)}}render(){return ue().createElement("button",{type:"button",className:"jp-Button lsp-help-button",onClick:this.handleClick},"?")}}class Ee extends f.VDomRenderer{constructor(e){super(e),this.addClass("lsp-popover")}render(){var e;if(!(null===(e=this.model)||void 0===e?void 0:e.connection_manager))return null;const t=this.model.servers_available_not_in_use.map(((e,t)=>ue().createElement(xe,{key:t,server:e})));let n=new Array,i=-1;for(let[e,t]of this.model.documents_by_server.entries()){i+=1;let s=new Array;for(let[n,o]of t){let t=o.map(((e,t)=>{let n=this.model.connection_manager.connections.get(e.uri),i="";i=(null==n?void 0:n.isInitialized)?"initialized":(null==n?void 0:n.isConnected)?"connected":"not connected";const s="initialized"===i?de.circleIcon:de.circleEmptyIcon;return ue().createElement("li",{key:t},ue().createElement(ye,{document:e,adapter:this.model.adapter}),ue().createElement("span",{className:"lsp-document-status"},this.model.trans.__(i),ue().createElement(s.react,{tag:"span",className:"lsp-document-status-icon",elementSize:"small"})))}));s.push(ue().createElement("div",{key:i,className:"lsp-documents-by-language"},ue().createElement("h5",null,n," ",ue().createElement("span",{className:"lsp-language-server-name"},"(",e.spec.display_name,")")),ue().createElement("ul",null,t)))}n.push(ue().createElement("div",{key:i},s))}const s=this.model.missing_languages.map(((e,t)=>{const n=this.model.language_server_manager.getMatchingSpecs({language:e});return ue().createElement("div",{key:t,className:"lsp-missing-server"},e,n.size?ue().createElement(Se,{language:e,servers:n,trans:this.model.trans}):"")}));return ue().createElement("div",{className:"lsp-popover-content"},ue().createElement("div",{className:"lsp-servers-menu"},ue().createElement("h3",{className:"lsp-servers-title"},this.model.trans.__("LSP servers")),ue().createElement("div",{className:"lsp-servers-lists"},t.length?ue().createElement(ke,{key:"available",title:this.model.trans.__("Available"),list:t,startCollapsed:!0}):"",n.length?ue().createElement(ke,{key:"running",title:this.model.trans.__("Running"),list:n}):"",s.length?ue().createElement(ke,{key:"missing",title:this.model.trans.__("Missing"),list:s}):"")),ue().createElement("div",{className:"lsp-popover-status"},this.model.trans.__("Documentation:")," ",ue().createElement("a",{href:"https://jupyterlab-lsp.readthedocs.io/en/latest/Language%20Servers.html",target:"_blank",rel:"noreferrer"},this.model.trans.__("Language Servers"))))}}const Me="jp-mod-selected";class je extends f.VDomRenderer{constructor(e,t=!0,n){super(new je.Model(e,n)),this.displayText=t,this._popup=null,this.handleClick=()=>{this._popup&&this._popup.dispose(),"no_server_extension"==this.model.status.status?(0,f.showDialog)({title:this.trans.__("LSP server extension not found"),body:pe,buttons:[be()]}).catch(console.warn):this._popup=(0,x.showPopup)({body:new Ee(this.model),anchor:this,align:"left"})},this.addClass(x.interactiveItem),this.addClass("lsp-statusbar-item"),this.trans=n,this.title.caption=this.trans.__("LSP status"),this.interactiveStateObserver=new MutationObserver((()=>{const e=this.node.classList.contains(Me);this.node.classList.contains(x.interactiveItem)?e&&this.removeClass(Me):e||this.addClass(Me)}))}onAfterAttach(e){super.onAfterAttach(e),this.interactiveStateObserver.observe(this.node,{attributes:!0,attributeFilter:["class"]})}onBeforeDetach(e){super.onBeforeDetach(e),this.interactiveStateObserver.disconnect()}render(){const{model:e}=this;return null==e?null:ue().createElement(x.GroupItem,{spacing:this.displayText?2:0,title:e.long_message,onClick:this.handleClick,className:"lsp-status-group"},ue().createElement(e.status_icon.react,{top:"2px",kind:"statusBar",title:this.trans.__("LSP Code Intelligence")}),this.displayText?ue().createElement(x.TextItem,{className:"lsp-status-message",source:e.short_message}):null,ue().createElement(x.TextItem,{source:e.feature_message}))}}class Ie{constructor(e){this.options=e}createItem(e=!0){const t=new je(this.options.adapter_manager,e,this.options.translator_bundle);return t.model.language_server_manager=this.options.language_server_manager,t.model.connection_manager=this.options.connection_manager,t}createNew(e,t){const n=this.createItem(!1);return n.addClass("jp-ToolbarButton"),e.toolbar.insertAfter("spacer","LSPStatus",n),n}}const Te={no_server_extension:"error",waiting:"inactive",initialized:"ready",initializing:"preparing",initialized_but_some_missing:"ready",connecting:"preparing"},Le={no_server_extension:me,waiting:ve,initialized:fe,initializing:ve,initialized_but_some_missing:me,connecting:ve},Re={no_server_extension:"Server extension missing",waiting:"Waiting...",initialized:"Fully initialized",initialized_but_some_missing:"Initialized (additional servers needed)",initializing:"Initializing...",connecting:"Connecting..."};!function(e){class t extends f.VDomModel{constructor(e,t){super(),this.server_extension_status=null,this._onChange=()=>{this.stateChanged.emit(void 0)},this._adapter=null,this.trans=t,e.adapterChanged.connect(((e,t)=>{this.change_adapter(t)}),this),e.adapterDisposed.connect(((e,t)=>{this.adapter===t&&this.change_adapter(null)}),this)}get available_servers(){return this.language_server_manager.sessions}get supported_languages(){const e=new Set;for(let t of this.available_servers.values())for(let n of t.spec.languages)e.add(n.toLocaleLowerCase());return e}is_server_running(e,t){for(const t of this.detected_languages){const n=this.language_server_manager.getMatchingServers({language:t});if(n.length&&n[0]===e)return!0}}get documents_by_server(){var e;let t=new Map;if(!(null===(e=this.adapter)||void 0===e?void 0:e.virtual_editor))return t;let n=X(this.adapter.virtual_editor.virtual_document);for(let e of n.values()){let n=e.language.toLocaleLowerCase(),i=this._connection_manager.language_server_manager.getMatchingServers({language:e.language});if(0===i.length)continue;let s=this.language_server_manager.sessions.get(i[0]);t.has(s)||t.set(s,new Map);let o=t.get(s);o.has(n)||o.set(n,new Array),o.get(n).push(e)}return t}get servers_available_not_in_use(){return[...this.available_servers.entries()].filter((([e,t])=>!this.is_server_running(e,t))).map((([e,t])=>t))}get detected_languages(){var e;return(null===(e=this.adapter)||void 0===e?void 0:e.virtual_editor)?function(e){let t=X(e);return new Set([...t].map((e=>e.language.toLocaleLowerCase())))}(this.adapter.virtual_editor.virtual_document):new Set}get missing_languages(){return[...this.detected_languages].filter((e=>!this.supported_languages.has(e.toLocaleLowerCase())))}get status(){var e;let t;if(null===(e=this.adapter)||void 0===e?void 0:e.virtual_editor){let e=this.adapter.virtual_editor.virtual_document;const n=this._connection_manager.documents,i=X(e);t=new Map([...n].filter((([e,t])=>i.has(t))))}else t=new Map;let n=new Set,i=new Set,s=new Set,o=new Set,r=new Set;t.forEach(((e,t)=>{let a=this._connection_manager.connections.get(t);0!==this._connection_manager.language_server_manager.getMatchingServers({language:e.language}).length&&r.add(e),a?(o.add(e),a.isConnected&&n.add(e),a.isInitialized&&i.add(e)):s.add(e)}));let a,l=new Array;return this._connection_manager.connections.forEach(((e,t)=>{e.isConnected&&l.push(e)})),a=404===this.language_server_manager.statusCode?"no_server_extension":0===t.size?"waiting":i.size===t.size?"initialized":i.size===o.size&&t.size>r.size?"initialized_but_some_missing":n.size===o.size?"initializing":"connecting",{open_connections:l,connected_documents:n,initialized_documents:i,detected_documents:new Set([...t.values()]),status:a}}get status_icon(){return this.adapter?Le[this.status.status].bindprops({className:"lsp-status-icon "+Te[this.status.status]}):de.stopIcon}get short_message(){return this.adapter?this.trans.__(Re[this.status.status]):this.trans.__("not initialized")}get feature_message(){var e,t;return(null===(t=null===(e=this.adapter)||void 0===e?void 0:e.status_message)||void 0===t?void 0:t.message)||""}get long_message(){if(!this.adapter)return this.trans.__("not initialized");let e=this.status,t="";if("waiting"===e.status)t=this.trans.__("Waiting for documents initialization...");else if("initialized"===e.status)t=this.trans._n("Fully connected & initialized (%2 virtual document)","Fully connected & initialized (%2 virtual document)",e.detected_documents.size,e.detected_documents.size);else if("initializing"===e.status){const n=new Set(e.detected_documents);for(let t of e.initialized_documents.values())n.delete(t);t=this.trans.__("Fully connected, but %2/%3 virtual document stuck uninitialized: %4","Fully connected, but %2/%3 virtual documents stuck uninitialized: %4",e.detected_documents.size,n.size,e.detected_documents.size,[...n].map((e=>e.id_path)).join(", "))}else{const n=new Set(e.detected_documents);for(let t of e.connected_documents.values())n.delete(t);t=this.trans.__("%2/%3 virtual document connected (%4 connections; waiting for: %5)","%2/%3 virtual documents connected (%4 connections; waiting for: %5)",e.detected_documents.size,e.connected_documents.size,e.detected_documents.size,e.open_connections.length,[...n].map((e=>e.id_path)).join(", "))}return t}get adapter(){return this._adapter}change_adapter(e){null!=this._adapter&&this._adapter.status_message.changed.disconnect(this._onChange),null!=e&&e.status_message.changed.connect(this._onChange),this._adapter=e}get connection_manager(){return this._connection_manager}set connection_manager(e){null!=this._connection_manager&&(this._connection_manager.connected.disconnect(this._onChange),this._connection_manager.initialized.connect(this._onChange),this._connection_manager.disconnected.disconnect(this._onChange),this._connection_manager.closed.disconnect(this._onChange),this._connection_manager.documents_changed.disconnect(this._onChange)),null!=e&&(e.connected.connect(this._onChange),e.initialized.connect(this._onChange),e.disconnected.connect(this._onChange),e.closed.connect(this._onChange),e.documents_changed.connect(this._onChange)),this._connection_manager=e}}e.Model=t}(je||(je={}));class Ae{constructor(){this.registry={}}register(e,t){this.registry.hasOwnProperty(t)||(this.registry[t]=[]),this.registry[t].push(e)}}const Pe={id:c.name,requires:[],activate:e=>new Ae,provides:c,autoStart:!0};var De,Oe,ze,$e,He,qe,Fe=n(2374),Ne=n(1754),We=n(5384);class Ve{constructor(e,t){this.settingRegistry=e,this.changed=new M.Signal(this),t in e.plugins?this.ready=new Promise((n=>{e.load(t).then((e=>{this.settings=e,n(),this.changed.emit(),e.changed.connect((()=>{this.settings=e,this.changed.emit()}))})).catch(console.warn)})):console.warn(t+" settings schema could not be found and was not loaded")}get composite(){return this.settings.composite}set(e,t){this.settings.set(e,t).catch(console.warn)}}function Ue(e,t){return _(P.lsp_to_ce(e),t)}class Be{constructor(e){this.feature=e.feature,this.virtual_editor=e.virtual_editor,this.virtual_document=e.virtual_document,this.connection=e.connection,this.status_message=e.status_message,this.adapter=e.adapter,this.console=this.adapter.console.scope(e.feature.name),this.trans=e.trans,this.editor_handlers=new Map,this.connection_handlers=new Map,this.wrapper_handlers=new Map,this.is_registered=!1}get settings(){return this.feature.settings}get lab_integration(){return this.feature.labIntegration}register(){for(let[e,t]of this.editor_handlers)this.virtual_editor.on(e,t);for(let[e,t]of this.connection_handlers)this.connection.on(e,t);this.wrapper=this.virtual_editor.getWrapperElement();for(let[e,t]of this.wrapper_handlers)this.wrapper.addEventListener(e,t);this.is_registered=!0}remove(){for(let[e,t]of this.editor_handlers)this.virtual_editor.off(e,t);this.editor_handlers.clear();for(let[e,t]of this.connection_handlers)this.connection.off(e,t);this.connection_handlers.clear();for(let[e,t]of this.wrapper_handlers)this.wrapper.removeEventListener(e,t);this.wrapper_handlers.clear()}range_to_editor_range(e,t){let n=P.lsp_to_cm(e.start),i=P.lsp_to_cm(e.end);if(null==t){let e=this.transform_virtual_position_to_root_position(n),i=this.virtual_editor.get_editor_at_root_position(e);t=this.virtual_editor.ce_editor_to_cm_editor.get(i)}return{start:this.virtual_document.transform_virtual_to_editor(n),end:this.virtual_document.transform_virtual_to_editor(i),editor:t}}position_from_mouse(e){return this.virtual_editor.coordsChar({left:e.clientX,top:e.clientY},"window")}transform_virtual_position_to_root_position(e){let t=this.virtual_document.virtual_lines.get(e.line).editor,n=this.virtual_document.transform_virtual_to_editor(e);return this.virtual_editor.transform_from_editor_to_root(t,n)}get_cm_editor(e){return this.virtual_editor.get_cm_editor(e)}get_language_at(e,t){return t.getModeAt(e).name}extract_last_character(e){if("paste"===e.origin){let t=e.text[e.text.length-1];return t[t.length-1]}return e.text[0][0]}highlight_range(e,t){return e.editor.getDoc().markText(e.start,e.end,{className:t})}is_whole_document_edit(e){let t=this.virtual_document.value,n=t.split("\n"),i=e.range,s=P.lsp_to_ce;return 0===_(s(i.start),n)&&_(s(i.end),n)===t.length}async apply_edit(e){let t,n,i=this.virtual_document.document_info.uri,s=e.documentChanges?e.documentChanges.map((e=>e)):function(e){let t=[];for(let n of Object.keys(e))t.push({textDocument:{uri:n},edits:e[n]});return t}(e.changes),o=0,r=[];for(let e of s){let s=e.textDocument.uri;if((0,z.Ei)(s,i)){let i;if(n=1===e.edits.length&&this.is_whole_document_edit(e.edits[0]),n)i=e.edits[0],o+=1;else{o=0;let t=this.virtual_document.value,n=t.split("\n"),s=new Map;for(let t of e.edits){let e=Ue(t.range.start,n);s.has(e)?console.warn("Edits should not overlap, ignoring an overlapping edit"):(s.set(e,t),o+=1)}let r=new z.Gl((()=>[])),a="",l=0,c=0,d=0,h=[...s.keys()].sort(((e,t)=>e-t));for(let e of h){let i=s.get(e),o=t.slice(l,e);for(let e=0;e<o.split("\n").length;e++)r.get_or_create(c).push(d),c+=1,d+=1;a+=o+i.newText;let h=Ue(i.range.end,n),u=t.slice(e,h);for(let e=0;e<i.newText.split("\n").length;e++)e<u.length&&(c+=1),d+=1,r.get_or_create(c).push(d);l=h}a+=t.slice(l,t.length),i={range:{start:{line:0,character:0},end:{line:n.length-1,character:n[n.length-1].length}},newText:a},console.assert(this.is_whole_document_edit(i))}t=this.apply_single_edit(i)}else r.push(`Workspace-wide edits not implemented: ${s} != ${i}`)}const a=s.every((e=>0===e.edits.length));return{appliedChanges:o,modifiedCells:t,wasGranular:!n&&!a,errors:r}}replace_fragment(e,t,n,i,s,o,r=!1){let a=this.virtual_document,l=e.split("\n").slice(n.line-s.line,i.line-s.line).join("\n");l.endsWith("\n")&&(l=l.slice(0,-1));let c=this.virtual_editor.ce_editor_to_cm_editor.get(t).getDoc(),d=c.getValue("\n"),{lines:h}=a.prepare_code_block({value:d,ce_editor:t}),u=h.join("\n");if(r){let t=P.cm_to_ce,n=_(t(s),h),i=_(t(o),h);l=u.slice(0,n)+e+u.slice(i)}if(u===l)return 0;let g=a.decode_code_block(l),p=c.getCursor();c.replaceRange(g,{line:0,ch:0},{line:i.line-n.line+1,ch:0});try{c.setCursor(p,p.ch,{scroll:!1})}catch(e){console.log("Could not place the cursor back",e)}return 1}afterChange(e,t){}apply_single_edit(e){let t=this.virtual_document,n=0,i=P.lsp_to_cm(e.range.start),s=P.lsp_to_cm(e.range.end),o=t.get_editor_at_virtual_line(i);if(o!==t.get_editor_at_virtual_line(s)){let r=o,a=i,l=Object.assign({},i),c=i.line,d=!1;for(;c<=s.line;){c++;let o=t.get_editor_at_virtual_line({line:c,ch:0});o===r?(l.line=c,l.ch=0,d=!1):(n+=this.replace_fragment(e.newText,r,a,l,i,s),d=!0,a={line:c,ch:0},l={line:c,ch:0},r=o)}d||(n+=this.replace_fragment(e.newText,r,a,l,i,s))}else n+=this.replace_fragment(e.newText,o,i,s,i,s);return n}}!function(e){e[e.Error=1]="Error",e[e.Warning=2]="Warning",e[e.Information=3]="Information",e[e.Hint=4]="Hint"}(De||(De={})),function(e){e[e.Text=1]="Text",e[e.Method=2]="Method",e[e.Function=3]="Function",e[e.Constructor=4]="Constructor",e[e.Field=5]="Field",e[e.Variable=6]="Variable",e[e.Class=7]="Class",e[e.Interface=8]="Interface",e[e.Module=9]="Module",e[e.Property=10]="Property",e[e.Unit=11]="Unit",e[e.Value=12]="Value",e[e.Enum=13]="Enum",e[e.Keyword=14]="Keyword",e[e.Snippet=15]="Snippet",e[e.Color=16]="Color",e[e.File=17]="File",e[e.Reference=18]="Reference",e[e.Folder=19]="Folder",e[e.EnumMember=20]="EnumMember",e[e.Constant=21]="Constant",e[e.Struct=22]="Struct",e[e.Event=23]="Event",e[e.Operator=24]="Operator",e[e.TypeParameter=25]="TypeParameter"}(Oe||(Oe={})),function(e){e[e.Text=1]="Text",e[e.Read=2]="Read",e[e.Write=3]="Write"}(ze||(ze={})),function(e){e[e.Invoked=1]="Invoked",e[e.TriggerCharacter=2]="TriggerCharacter",e[e.TriggerForIncompleteCompletions=3]="TriggerForIncompleteCompletions"}($e||($e={})),function(e){e[e.AutoInvoked=9999]="AutoInvoked"}(He||(He={})),function(e){e.abap="ABAP",e.bat="Windows Bat",e.bibtex="BibTeX",e.clojure="Clojure",e.coffeescript="Coffeescript",e.c="C",e.cpp="C++",e.csharp="C#",e.css="CSS",e.diff="Diff",e.dart="Dart",e.dockerfile="Dockerfile",e.elixir="Elixir",e.erlang="Erlang",e.fsharp="F#",e["git-commit"]="Git (commit)",e["git-rebase"]="Git (rebase)",e.go="Go",e.groovy="Groovy",e.handlebars="Handlebars",e.html="HTML",e.ini="Ini",e.java="Java",e.javascript="JavaScript",e.javascriptreact="JavaScript React",e.json="JSON",e.latex="LaTeX",e.less="Less",e.lua="Lua",e.makefile="Makefile",e.markdown="Markdown",e["objective-c"]="Objective-C",e["objective-cpp"]="Objective-C++",e.perl="Perl",e.perl6="Perl 6",e.php="PHP",e.powershell="Powershell",e.jade="Pug",e.python="Python",e.r="R",e.razor="Razor (cshtml)",e.ruby="Ruby",e.rust="Rust",e.scss="SCSS (syntax using curly brackets)",e.sass="SCSS (indented syntax)",e.scala="Scala",e.shaderlab="ShaderLab",e.shellscript="Shell Script (Bash)",e.sql="SQL",e.swift="Swift",e.typescript="TypeScript",e.typescriptreact="TypeScript React",e.tex="TeX",e.vb="Visual Basic",e.xml="XML",e.xsl="XSL",e.yaml="YAML"}(qe||(qe={}));var Ze=n(1674);class Ke{constructor(e,t,n,i,s){this.type=e,this.icon=t,this.match=n,this.connector=i,this.uri=s,this.label=n.label,this._setDocumentation(n.documentation),this._requested_resolution=!1,this._resolved=!1,this._detail=n.detail,this.self=this}get isDocumentationMarkdown(){return this._is_documentation_markdown}_setDocumentation(e){Ze.A_.is(e)?(this._documentation=e.value,this._is_documentation_markdown="markdown"===e.kind):(this._documentation=e,this._is_documentation_markdown=!1)}get insertText(){return this._currentInsertText||this.match.insertText||this.match.label}set insertText(e){this._currentInsertText=e}get sortText(){return this.match.sortText||this.match.label}get filterText(){return this.match.filterText}supportsResolution(){return this.connector.get_connection(this.uri).isCompletionResolveProvider()}get detail(){return this._detail}needsResolution(){return!this.documentation&&!this._resolved&&!this._requested_resolution&&this.supportsResolution()}isResolved(){return this._resolved}resolve(){if(this._resolved)return Promise.resolve(this);if(!this.supportsResolution())return Promise.resolve(this);if(this._requested_resolution)return(0,z.EU)((()=>this._resolved),100,50).then((()=>this));const e=this.connector.get_connection(this.uri);return this._requested_resolution=!0,e.getCompletionResolve(this.match).then((e=>{if(null===e)return e;this._setDocumentation(e.documentation),this._detail=e.detail,this._resolved=!0}))}get documentation(){return this.connector.should_show_documentation&&this._documentation?this._documentation:null}get deprecated(){return this.match.deprecated?this.match.deprecated:this.match.tags&&this.match.tags.some((e=>e==Ze.we.Deprecated))}}var Je=Fe.CompletionHandler.ICompletionItemsResponseType;class Ge{constructor(e){if(this.options=e,this.isDisposed=!1,this.responseType=Je,this._editor=e.editor,this._connections=e.connections,this.virtual_editor=e.virtual_editor,this._context_connector=new Fe.ContextConnector({editor:e.editor}),e.session){let t={editor:e.editor,session:e.session};this._kernel_connector=new Fe.KernelConnector(t),this._kernel_and_context_connector=new Fe.CompletionConnector(t)}this.lab_integration=e.labIntegration,this.console=e.console}get kernel_completions_first(){return this.options.settings.composite.kernelCompletionsFirst}get use_lsp_completions(){return-1==this.options.settings.composite.disableCompletionsFrom.indexOf("LSP")}get use_kernel_completions(){return-1==this.options.settings.composite.disableCompletionsFrom.indexOf("Kernel")}get suppress_continuous_hinting_in(){return this.options.settings.composite.suppressContinuousHintingIn}get suppress_trigger_character_in(){return this.options.settings.composite.suppressTriggerCharacterIn}get should_show_documentation(){return this.options.settings.composite.showDocumentation}dispose(){this.isDisposed||(this._connections=null,this.virtual_editor=null,this._context_connector=null,this._kernel_connector=null,this._kernel_and_context_connector=null,this.options=null,this._editor=null,this.isDisposed=!0)}get _has_kernel(){var e;return null!=(null===(e=this.options.session)||void 0===e?void 0:e.kernel)}get _is_kernel_idle(){var e,t;return"idle"==(null===(t=null===(e=this.options.session)||void 0===e?void 0:e.kernel)||void 0===t?void 0:t.status)}get _should_wait_for_busy_kernel(){return this.lab_integration.settings.composite.waitForBusyKernel}async _kernel_language(){return(await this.options.session.kernel.info).language_info.name}get _kernel_timeout(){return this.lab_integration.settings.composite.kernelResponseTimeout}get fallback_connector(){return this._kernel_and_context_connector?this._kernel_and_context_connector:this._context_connector}transform_from_editor_to_root(e){let t=P.ce_to_cm(e);return this.virtual_editor.transform_from_editor_to_root(this._editor,t)}async fetch(e){let t=this._editor;const n=t.getCursorPosition(),i=t.getTokenForPosition(n);if(this.trigger_kind==He.AutoInvoked){if(-1!==this.suppress_continuous_hinting_in.indexOf(i.type))return this.console.debug("Suppressing completer auto-invoke in",i.type),void(this.trigger_kind=$e.Invoked)}else if(this.trigger_kind==$e.TriggerCharacter&&-1!==this.suppress_trigger_character_in.indexOf(i.type))return this.console.debug("Suppressing completer auto-invoke in",i.type),void(this.trigger_kind=$e.Invoked);const s=t.getPositionAt(i.offset),o=t.getPositionAt(i.offset+i.value.length);let r=n.column-s.column-1;const a=i.value[n.column-s.column-1];let l=this.transform_from_editor_to_root(s),c=this.transform_from_editor_to_root(o),d=this.transform_from_editor_to_root(n),h=this.virtual_editor,u=h.document_at_root_position(l),_=h.root_position_to_virtual_position(l),g=h.root_position_to_virtual_position(c),p=h.root_position_to_virtual_position(d);const m=this.use_lsp_completions?this.fetch_lsp(i,a,_,g,p,u,r):Promise.resolve(null);let v=null;try{const t=this._kernel_timeout;if(this.use_kernel_completions&&this._kernel_connector&&this._has_kernel&&(this._is_kernel_idle||this._should_wait_for_busy_kernel)&&0!=t){const n=await this._kernel_language();if(u.language.toLocaleLowerCase()===n.toLowerCase()){let n,i=this._kernel_connector.fetch(e);n=-1==t?i:Promise.race([i,new Promise((e=>setTimeout((()=>e({start:null,end:null,matches:[],metadata:null})),t)))]),v=Promise.all([n.catch((e=>e)),m.catch((e=>e))]).then((([e,t])=>{let n=[];return null!=e&&n.push(this.transform_reply(e)),null!=t&&n.push(t),this.merge_replies(n,this._editor)}))}}v||(v=m.catch((t=>(this.console.warn("hint failed",t),this.fallback_connector.fetch(e).then(this.transform_reply)))))}catch(t){this.console.warn("kernel completions failed",t),v=this.fallback_connector.fetch(e).then(this.transform_reply)}return this.console.debug("All promises set up and ready."),v.then((e=>(e=this.suppress_if_needed(e,i,n),this.items=e.items,this.trigger_kind=$e.Invoked,e)))}get_connection(e){return this._connections.get(e)}async fetch_lsp(e,t,n,i,s,o,r){let a=this.get_connection(o.uri);this.console.debug("Fetching"),this.console.debug("Token:",e,n,i);const l=this.trigger_kind==He.AutoInvoked?$e.Invoked:this.trigger_kind;let c=await a.getCompletion(s,{start:n,end:i,text:e.value},o.document_info,!1,t,l)||[];this.console.debug("Transforming");let d=e.value.slice(0,r+1),h=!0,u=[];c.forEach((t=>{let n=t.kind?Oe[t.kind]:"",i=t.insertText?t.insertText:t.label;if(i.toLowerCase().startsWith(d.toLowerCase()))h=!1,d!==e.value&&i.toLowerCase().startsWith(e.value.toLowerCase())&&(d=e.value);else if("string"===e.type&&d.includes("/")){const e=d.split("/");if(i.toLowerCase().startsWith(e[e.length-1].toLowerCase())){let n=e.slice(0,-1).join("/")+"/";t.insertText=n+t.insertText,(n.startsWith("'")||n.startsWith('"'))&&(n=n.substr(1)),t.label=n+t.label,h=!1}}let s=new Ke(n,this.icon_for(n),t,this,o.uri);u.push(s)})),this.console.debug("Transformed");let _=e.value.length;h&&_>d.length&&(_=d.length);let g={start:e.offset+(h?_:0),end:e.offset+d.length,items:u,source:{name:"LSP",priority:2}};return g.start>g.end&&console.warn("Response contains start beyond end; this should not happen!",g),g}icon_for(e){if(this.options.settings.composite.theme)return void 0===e&&(e=We.OC),this.options.themeManager.get_icon(e)||void 0}transform_reply(e){let t;this.console.log("Transforming kernel reply:",e);const n=(e.metadata||{})._jupyter_types_experimental;return t=n?n.map((e=>({label:e.text,insertText:e.text,type:"<unknown>"===e.type?void 0:e.type,icon:this.icon_for(e.type),sortText:this.kernel_completions_first?"a":"z"}))):e.matches.map((e=>({label:e,insertText:e,sortText:this.kernel_completions_first?"a":"z"}))),{start:e.start,end:e.end,source:{name:"Kernel",priority:1,fallbackIcon:this.icon_for("Kernel")},items:t}}merge_replies(e,t){this.console.debug("Merging completions:",e),(e=e.filter((e=>e instanceof Error?(this.console.warn(`Caught ${e.source.name} completions error`,e),!1):!!e.items.length))).sort(((e,t)=>t.source.priority-e.source.priority)),this.console.debug("Sorted replies:",e);const n=Math.min(...e.map((e=>e.end))),i=Math.min(...e.map((e=>e.start))),s=Math.max(...e.map((e=>e.start)));if(i!=s){const n=t.getCursorPosition(),i=t.getLine(n.line);e=e.map((e=>{if(e.start==s)return e;let t=i.substring(e.start,s);return this.console.debug(`Removing ${e.source.name} prefix: `,t),Object.assign(Object.assign({},e),{items:e.items.map((e=>(e.insertText=e.insertText.startsWith(t)?e.insertText.substr(t.length):e.insertText,e)))})}))}const o=new Set,r=new Array;for(const t of e)t.items.forEach((e=>{let n=e.insertText.trim();if(o.has(n))return;o.add(n);let i=e;i.source=t.source,i.icon||(i.icon=t.source.fallbackIcon),r.push(i)}));return this.console.debug("Merged: ",r),{start:s,end:n,source:null,items:r}}list(e){return Promise.resolve(void 0)}remove(e){return Promise.resolve(void 0)}save(e,t){return Promise.resolve(void 0)}suppress_if_needed(e,t,n){if(!this._editor.hasFocus())return this.console.debug("Ignoring completion response: the corresponding editor lost focus"),{start:e.start,end:e.end,items:[]};const i=this._editor.getCursorPosition();return n.line!=i.line||i.column<n.column?(this.console.debug("Ignoring completion response: cursor has receded or changed line"),{start:e.start,end:e.end,items:[]}):this.trigger_kind==He.AutoInvoked&&(e.start==e.end||1===e.items.length&&e.items[0].insertText===t.value)?{start:e.start,end:e.end,items:[]}:e}}var Xe=n(9850);function Ye(e){let t=document.createElement("span");return t.textContent=e,t.innerHTML}class Qe extends Fe.CompleterModel{constructor(e={}){super(),this.settings=Object.assign(Object.assign({},Qe.defaultOptions),e)}completionItems(){let e=this.query;this.query="";let t=super.completionItems();return this.query=e,this._sortAndFilter(e,t)}setCompletionItems(e){super.setCompletionItems(e)}_markFragment(e){return`<mark>${e}</mark>`}getFilterText(e){return this.getHighlightableLabelRegion(e)}getHighlightableLabelRegion(e){const t=e.label.indexOf("(");return t>-1?e.label.substring(0,t):e.label}_sortAndFilter(e,t){let n=[];for(let i of t){let t,s,o=null,r=e.toLowerCase();if(e?(o=this.getFilterText(i),s=this.settings.caseSensitive?Xe.StringExt.matchSumOfSquares(o,e):Xe.StringExt.matchSumOfSquares(o.toLowerCase(),r),t=!!s,this.settings.includePerfectMatches||(t=t&&o!=e)):t=!0,t){let t,r,a;if(e){let n=Ye(this.getHighlightableLabelRegion(i));t=n==o?s:Xe.StringExt.matchSumOfSquares(n,e)}t?(r=Xe.StringExt.highlight(Ye(i.label),t.indices,this._markFragment).join(""),a=t.score):(r=Ye(i.label),a=0);const l=Object.create(Object.getPrototypeOf(i),Object.getOwnPropertyDescriptors(i));l.label=r,l.insertText=i.insertText?i.insertText:i.label,n.push({item:l,score:a})}}return n.sort(this.compareMatches),n.map((e=>e.item))}compareMatches(e,t){var n,i,s;const o=e.score-t.score;return 0!==o?o:null!==(s=null===(n=e.item.insertText)||void 0===n?void 0:n.localeCompare(null!==(i=t.item.insertText)&&void 0!==i?i:""))&&void 0!==s?s:0}}!function(e){e.defaultOptions={caseSensitive:!0,includePerfectMatches:!0}}(Qe||(Qe={}));class et extends Qe{getFilterText(e){return e.filterText?e.filterText:super.getFilterText(e)}compareMatches(e,t){const n=e.score-t.score;return 0!==n?n:e.item.sortText.localeCompare(t.item.sortText)}}class tt extends Fe.Completer.Renderer{constructor(e){super(),this.options=e,this.ITEM_PLACEHOLDER_CLASS="lsp-detail-placeholder",this.EXTRA_INFO_CLASS="jp-Completer-typeExtended",this.activeChanged=new M.Signal(this),this.itemShown=new M.Signal(this),this.elementToItem=new WeakMap,this.wasActivated=new WeakMap,this.visibilityObserver=new IntersectionObserver((e=>{e.forEach((e=>{if(!e.isIntersecting)return;let t=e.target,n=this.elementToItem.get(t);this.itemShown.emit({item:n,element:t})}))}),{threshold:.25}),this.activityObserver=new MutationObserver((e=>{e.forEach((e=>{let t=e.target;if(!(t instanceof HTMLLIElement))return;let n=!this.wasActivated.get(t);if(t.classList.contains("jp-mod-active")){if(n){this.wasActivated.set(t,!0);let e=this.elementToItem.get(t);this.activeChanged.emit({item:e,element:t})}}else this.wasActivated.set(t,!1)}))}))}getExtraInfo(e){var t,n,i,s,o,r;const a=this.options.integrator.settings.composite.labelExtra;switch(a){case"detail":return null==e?void 0:e.detail;case"type":return null===(n=null===(t=null==e?void 0:e.type)||void 0===t?void 0:t.toLowerCase)||void 0===n?void 0:n.call(t);case"source":return null===(i=null==e?void 0:e.source)||void 0===i?void 0:i.name;case"auto":return[null==e?void 0:e.detail,null===(o=null===(s=null==e?void 0:e.type)||void 0===s?void 0:s.toLowerCase)||void 0===o?void 0:o.call(s),null===(r=null==e?void 0:e.source)||void 0===r?void 0:r.name].filter((e=>!!e))[0];default:this.options.console.warn("labelExtra does not match any of the expected values",a)}}updateExtraInfo(e,t){const n=this.getExtraInfo(e);n&&(t.getElementsByClassName(this.EXTRA_INFO_CLASS)[0].textContent=n)}createCompletionItemNode(e,t){const n=super.createCompletionItemNode(e,t),i=e.self;return i?(i.element=n,this.elementToItem.set(n,i),this.activityObserver.observe(n,{attributes:!0,attributeFilter:["class"]}),this.visibilityObserver.observe(n),this.updateExtraInfo(i,n)):this.updateExtraInfo(e,n),n}createDocumentationNode(e){if(e.isDocumentationMarkdown){let t=e.documentation;return this.options.markdownRenderer.renderModel({data:{"text/markdown":t},trusted:!1,metadata:{},setData(e){}}).then((()=>{this.options.latexTypesetter&&t.includes("$")&&this.options.latexTypesetter.typeset(this.options.markdownRenderer.node)})).catch(this.options.console.warn),this.options.markdownRenderer.node}{let t=document.createElement("pre");return t.textContent=e.documentation,t}}}const nt=".jp-Completer-docpanel",it="lsp-completer-placeholder";class st extends Be{get settings(){return super.settings}get completionCharacters(){return null!=this._completionCharacters&&this._completionCharacters.length||(this._completionCharacters=this.connection.getLanguageCompletionCharacters()),this._completionCharacters}afterChange(e){let t=this.extract_last_character(e);if(this.completionCharacters.indexOf(t)>-1)return this.virtual_editor.console.log("Will invoke completer after",t),void this.feature.labIntegration.invoke_completer($e.TriggerCharacter).catch(this.console.warn);e.text&&1==e.text[0].length&&this.settings.composite.continuousHinting&&this.feature.labIntegration.invoke_completer(He.AutoInvoked).catch(this.console.warn)}}class ot{constructor(e,t,n,i,s,o,r){this.app=e,this.completionManager=t,this.settings=n,this.adapterManager=i,this.completionThemeManager=s,this.console=o,this.renderMimeRegistry=r,this.current_adapter=null,this._latestActiveItem=null;const a=this.renderMimeRegistry.createRenderer("text/markdown");this.renderer=new tt({integrator:this,markdownRenderer:a,latexTypesetter:this.renderMimeRegistry.latexTypesetter,console:o.scope("renderer")}),this.renderer.activeChanged.connect(this.active_completion_changed,this),this.renderer.itemShown.connect(this.resolve_and_update,this),n.ready.then((()=>{n.composite.disable||i.adapterChanged.connect(this.swap_adapter,this)})).catch(o.warn),n.changed.connect((()=>{s.set_theme(this.settings.composite.theme),s.set_icons_overrides(this.settings.composite.typesMap),this.current_completion_handler&&(this.model.settings.caseSensitive=this.settings.composite.caseSensitive,this.model.settings.includePerfectMatches=this.settings.composite.includePerfectMatches)}))}fetchDocumentation(e){e&&e.resolve().then((t=>{e.self===this._latestActiveItem.self&&(this.set_doc_panel_placeholder(!1),null!==t&&this.refresh_doc_panel(e))})).catch((t=>{e.self===this._latestActiveItem.self&&this.set_doc_panel_placeholder(!1),this.console.warn(t)}))}active_completion_changed(e,t){let{item:n}=t;if(this._latestActiveItem=n,!n.supportsResolution())return void(n.isDocumentationMarkdown&&this.refresh_doc_panel(n));n.needsResolution()?(this.set_doc_panel_placeholder(!0),this.fetchDocumentation(n)):n.isResolved()?this.refresh_doc_panel(n):this.fetchDocumentation(n);const i=this.current_index,s=this.current_items;if(i-1>=0){const e=s[i-1];this.resolve_and_update_from_item(null==e?void 0:e.self)}if(i+1<s.length){const e=s[i+1];this.resolve_and_update_from_item(null==e?void 0:e.self)}}resolve_and_update_from_item(e){e&&this.resolve_and_update(this.renderer,{item:e,element:e.element})}resolve_and_update(e,t){let{item:n,element:i}=t;n.supportsResolution()?n.isResolved()?this.renderer.updateExtraInfo(n,i):n.resolve().then((e=>{this.renderer.updateExtraInfo(n,i)})).catch((e=>{this.console.warn(e)})):this.renderer.updateExtraInfo(n,i)}swap_adapter(e,t){this.current_adapter&&(this.current_adapter.activeEditorChanged.disconnect(this.set_connector,this),this.current_adapter.adapterConnected.disconnect(this.connect_completion,this)),this.current_adapter=t,this.current_adapter.isConnected&&(this.connect_completion(this.current_adapter),this.set_connector(t,{editor:t.activeEditor})),this.current_adapter.activeEditorChanged.connect(this.set_connector,this),this.current_adapter.adapterConnected.connect(this.connect_completion,this)}connect_completion(e,t){let n=e.activeEditor;if(null==n)return;this.set_completion_connector(e,n),this.current_completion_handler=this.completionManager.register({connector:this.current_completion_connector,editor:n,parent:e.widget},this.renderer);let i=this.completer;i.addClass("lsp-completer"),i.model=new et({caseSensitive:this.settings.composite.caseSensitive,includePerfectMatches:this.settings.composite.includePerfectMatches})}get completer(){return this.current_completion_handler.completer}get model(){return this.completer.model}invoke_completer(e){let t;return this.current_completion_connector.trigger_kind=e,t=this.adapterManager.currentAdapter instanceof ae?"completer:invoke-notebook":"completer:invoke-file",this.app.commands.execute(t).catch((()=>{this.current_completion_connector.trigger_kind=$e.Invoked}))}set_connector(e,t){this.current_completion_handler||this.connect_completion(e),this.set_completion_connector(e,t.editor),this.current_completion_handler.editor=t.editor,this.current_completion_handler.connector=this.current_completion_connector}get current_items(){return this.model.completionItems()}get current_index(){return this.current_completion_handler.completer._activeIndex}refresh_doc_panel(e){let t=this.current_completion_handler.completer;const n=this.current_items[this.current_index];if(!e||!n||n.insertText!=e.insertText)return;const i=t.node.querySelector(nt);if(i.classList.remove(it),e.documentation){i.textContent="";const t=this.renderer.createDocumentationNode(e);i.appendChild(t),i.setAttribute("style","")}else i.setAttribute("style","display: none")}set_doc_panel_placeholder(e){const t=this.current_completion_handler.completer.node.querySelector(nt);e?(t.setAttribute("style",""),t.classList.add(it)):t.classList.contains(it)&&(t.setAttribute("style","display: none"),t.classList.remove(it))}set_completion_connector(e,t){var n,i;this.current_completion_connector&&delete this.current_completion_connector,this.current_completion_connector=new Ge({editor:t,themeManager:this.completionThemeManager,connections:this.current_adapter.connection_manager.connections,virtual_editor:this.current_adapter.virtual_editor,settings:this.settings,labIntegration:this,session:null===(i=null===(n=this.current_adapter.widget)||void 0===n?void 0:n.sessionContext)||void 0===i?void 0:i.session,console:this.console})}}new de.LabIcon({name:"lsp:completion",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n     <path d="M5,9.5L7.5,14H2.5L5,9.5M3,4H7V8H3V4M5,20A2,2 0 0,0 7,18A2,2 0 0,0 5,16A2,2 0 0,0 3,18A2,2 0 0,0 5,20M9,5V7H21V5H9M9,19H21V17H9V19M9,13H21V11H9V13Z" />\n  </g>\n</svg>\n'});const rt=o+":completion",at={id:rt,requires:[r,b.ISettingRegistry,Fe.ICompletionManager,a,We.kZ,d,Ne.IRenderMimeRegistry],autoStart:!0,activate:(e,t,n,i,s,o,r,a)=>{const l=new Ve(n,rt),c=new ot(e,i,l,s,o,r.scope("CompletionLab"),a);t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",st]]),id:rt,name:"LSP Completion",labIntegration:c,settings:l}})}};var lt=n(3706),ct=n(2768),dt=n(8337);const ht='<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M12 14a2 2 0 012 2 2 2 0 01-2 2 2 2 0 01-2-2 2 2 0 012-2m11.46-5.14l-1.59 6.89L15 14.16l3.8-2.38A7.972 7.972 0 0012 8c-3.95 0-7.23 2.86-7.88 6.63l-1.97-.35C2.96 9.58 7.06 6 12 6c3.58 0 6.73 1.89 8.5 4.72l2.96-1.86z"/>\n  </g>\n</svg>\n',ut=new de.LabIcon({name:"lsp:jump-to",svgstr:ht}),_t=new de.LabIcon({name:"lsp:jump-back",svgstr:ht.replace("jp-icon3","lsp-icon-flip-x jp-icon3")}),gt=o+":jump_to";let pt;class mt extends Be{get jumper(){return this.feature.labIntegration.jumper}get settings(){return super.settings}get modifierKey(){return this.settings.composite.modifierKey}register(){this.editor_handlers.set("mousedown",((e,t)=>{let n=this.position_from_mouse(t),i=e.document_at_root_position(n),s=e.root_position_to_virtual_position(n);const{button:o}=t;0===o&&(0,z.nE)(t,this.modifierKey)&&(this.connection.getDefinition(s,i.document_info,!1).then((e=>{this.handle_jump(e,i.document_info.uri).catch(this.console.warn)})).catch(this.console.warn),t.preventDefault(),t.stopPropagation())})),super.register()}get_uri_and_range(e){if(null==e)return;const t=Array.isArray(e)?e:[e];if(0===t.length)return;this.console.log("Will jump to the first of suggested locations:",t);const n=t[0];return"targetUri"in n?{uri:n.targetUri,range:n.targetRange}:"uri"in n?{uri:n.uri,range:n.range}:void 0}async handle_jump(e,t){const n=this.get_uri_and_range(e);if(!n)return void this.status_message.set(pt.__("No jump targets found"),2e3);let{uri:i,range:s}=n,o=P.lsp_to_cm(s.start);if((0,z.Ei)(i,t)){let e=this.adapter.get_editor_index_at(o),t=this.virtual_editor.transform_virtual_to_editor(o),n=P.cm_to_ce(t);this.console.log(`Jumping to ${e}th editor of ${i}`),this.console.log("Jump target within editor:",n);let s=this.adapter.widget.context.path;this.jumper.global_jump({line:n.line,column:t.ch,editor_index:e,is_symlink:!1,contents_path:s})}else{let e=P.cm_to_ce(o);this.console.log("Jumping to external file: "+i),this.console.log("Jump target (source location):",e);let t={editor_index:0,line:e.line,column:e.column},n=(0,z.lj)(i);null==n&&i.startsWith("file://")&&(n=decodeURI(i.slice(7)));try{return await this.jumper.document_manager.services.contents.get(n,{content:!1}),void this.jumper.global_jump(Object.assign(Object.assign({contents_path:n},t),{is_symlink:!1}))}catch(e){this.console.warn(e)}this.jumper.global_jump(Object.assign(Object.assign({contents_path:O.URLExt.join(".lsp_symlink",n)},t),{is_symlink:!0}))}}}class vt{constructor(e,t,n,i,s){this.settings=e,this.adapterManager=t,this.jumpers=new Map,null!==s&&s.widgetAdded.connect(((e,t)=>{if(t.content.editor instanceof ct.CodeMirrorEditor){let e=new dt.FileEditorJumper(t,i);this.jumpers.set(t.id,e)}})),n.widgetAdded.connect((async(e,t)=>{let n=new dt.NotebookJumper(t,i);this.jumpers.set(t.id,n)}))}get jumper(){let e=this.adapterManager.currentAdapter.widget.id;return this.jumpers.get(e)}}const ft=e=>[{id:"jump-to-definition",execute:async({connection:e,virtual_position:t,document:n,features:i})=>{const s=i.get(gt),o=await e.getDefinition(t,n.document_info,!1);await s.handle_jump(o,n.document_info.uri)},is_enabled:({connection:e})=>e.isDefinitionSupported(),label:e.__("Jump to definition"),icon:ut},{id:"jump-back",execute:async({connection:e,virtual_position:t,document:n,features:i})=>{i.get(gt).jumper.global_jump_back()},is_enabled:({connection:e})=>e.isDefinitionSupported(),label:e.__("Jump back"),icon:_t,attach_to:new Set}],wt={id:gt,requires:[r,b.ISettingRegistry,a,re.INotebookTracker,w.IDocumentManager,k.ITranslator],optional:[A.IEditorTracker],autoStart:!0,activate:(e,t,n,i,s,o,r,a)=>{const l=new Ve(n,gt);pt=r.load("jupyterlab-lsp");let c=new vt(l,i,s,o,a);t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",mt]]),commands:ft(pt),id:gt,name:"Jump to definition",labIntegration:c,settings:l}})}};var yt=n(2372);I()(yt.Z,{insert:"head",singleton:!1}),yt.Z.locals;class bt extends Map{get all(){return[].concat.apply([],this.values())}}class xt{constructor(e){this.options=e,this.is_visible=!0}render_cell(e,t){return this.options.render_cell(e,t)}sort(e,t){return this.options.sort(e,t)}get id(){return this.options.id}is_available(e){return null==this.options.is_available||this.options.is_available(e)}render_header(e){return ue().createElement(kt,{label:this.options.label,id:this.id,listing:e,key:this.id})}}function kt(e){const t=e.id===e.listing.sort_key,n=t&&1!==e.listing.sort_direction?de.caretDownIcon:de.caretUpIcon;return ue().createElement("th",{key:e.id,onClick:()=>e.listing.sort(e.id),className:t?"lsp-sorted-header":null},ue().createElement("div",null,ue().createElement("label",null,e.label),ue().createElement(n.react,{tag:"span",className:"lsp-sort-icon"})))}class Ct extends f.VDomRenderer{constructor(e){super(e),this.sort_key="Severity",this.sort_direction=1;const t=e.trans;this.trans=t,this.severityTranslations={Error:t.__("Error"),Warning:t.__("Warning"),Information:t.__("Information"),Hint:t.__("Hint")},this.columns=[new xt({id:"Virtual Document",label:this.trans.__("Virtual Document"),render_cell:(e,t)=>ue().createElement("td",{key:0},ue().createElement(ye,{document:e.document,adapter:t.adapter,trans:this.trans})),sort:(e,t)=>e.document.id_path.localeCompare(t.document.id_path),is_available:e=>e.db.size>1}),new xt({id:"Message",label:this.trans.__("Message"),render_cell:e=>{let t=function(e){let t=e.message,n=""+e.code;return null!=e.code&&""!==e.code&&t.startsWith(n+"")?t.slice(n.length).trim():t}(e.data.diagnostic);return ue().createElement("td",{key:1},t)},sort:(e,t)=>e.data.diagnostic.message.localeCompare(t.data.diagnostic.message)}),new xt({id:"Code",label:this.trans.__("Code"),render_cell:e=>ue().createElement("td",{key:2},e.data.diagnostic.code),sort:(e,t)=>(e.data.diagnostic.code+"").localeCompare(t.data.diagnostic.source+"")}),new xt({id:"Severity",label:this.trans.__("Severity"),render_cell:e=>{const t=De[e.data.diagnostic.severity||1];return ue().createElement("td",{key:3},this.severityTranslations[t]||t)},sort:(e,t)=>e.data.diagnostic.severity>t.data.diagnostic.severity?1:-1}),new xt({id:"Source",label:this.trans.__("Source"),render_cell:e=>ue().createElement("td",{key:4},e.data.diagnostic.source),sort:(e,t)=>e.data.diagnostic.source.localeCompare(t.data.diagnostic.source)}),new xt({id:"Cell",label:this.trans.__("Cell"),render_cell:e=>ue().createElement("td",{key:5},e.cell_number),sort:(e,t)=>e.cell_number>t.cell_number||e.data.range.start.line>t.data.range.start.line||e.data.range.start.ch>t.data.range.start.ch?1:-1,is_available:e=>e.adapter.has_multiple_editors}),new xt({id:"Line:Ch",label:this.trans.__("Line:Ch"),render_cell:e=>ue().createElement("td",{key:6},e.data.range.start.line,":",e.data.range.start.ch),sort:(e,t)=>e.data.range.start.line>t.data.range.start.line||e.data.range.start.ch>t.data.range.start.ch?1:-1})]}sort(e){e===this.sort_key?this.sort_direction=-1*this.sort_direction:(this.sort_key=e,this.sort_direction=1),this.update()}render(){let e=this.model.diagnostics;const t=this.model.virtual_editor,n=this.model.adapter;if(!e||null==t)return ue().createElement("div",null,this.trans.__("No issues detected, great job!"));let i=Array.from(e).map((([e,i])=>e.isDisposed?[]:i.map(((i,s)=>{let o=null;if(n.has_multiple_editors){let{index:e}=t.find_editor(i.editor);o=e+1}return{data:i,key:e.uri+","+s,document:e,cell_number:o,editor:t}})))),s=[].concat.apply([],i);this._diagnostics=new Map(s.map((e=>[e.key,e])));let o=this.columns.filter((e=>e.id===this.sort_key))[0],r=o.sort.bind(o),a=s.sort(((e,t)=>r(e,t)*this.sort_direction)),l={db:e,editor:t,adapter:n},c=this.columns.filter((e=>e.is_available(l)&&e.is_visible)),d=a.map((e=>{let t=c.map((t=>t.render_cell(e,l)));return ue().createElement("tr",{key:e.key,"data-key":e.key,onClick:()=>{this.jump_to(e)}},t)})),h=c.map((e=>e.render_header(this)));return ue().createElement("table",{className:"lsp-diagnostics-listing"},ue().createElement("thead",null,ue().createElement("tr",null,h)),ue().createElement("tbody",null,d))}get_diagnostic(e){if(this._diagnostics.has(e))return this._diagnostics.get(e);console.warn("Could not find the diagnostics row with key",e)}jump_to(e){const t=e.data.editor;we(t.getWrapperElement()),t.getDoc().setCursor(e.data.range.start),t.focus()}}!function(e){class t extends f.VDomModel{constructor(e){super(),this.trans=e}}e.Model=t}(Ct||(Ct={}));const St=new de.LabIcon({name:"lsp:diagnostics",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M19 8c.56 0 1 .43 1 1a1 1 0 01-1 1c-.57 0-1-.45-1-1 0-.57.43-1 1-1M2 2v9c0 2.96 2.19 5.5 5.14 5.91.62 3.01 3.28 5.09 6.36 5.09a6.5 6.5 0 006.5-6.5v-3.69c1.16-.42 2-1.52 2-2.81a3 3 0 00-3-3 3 3 0 00-3 3c0 1.29.84 2.4 2 2.81v3.6c0 2.5-2 4.5-4.5 4.5-2 0-3.68-1.21-4.28-3.01C12 16.3 14 13.8 14 11V2h-4v3h2v6a4 4 0 01-4 4 4 4 0 01-4-4V5h2V2H2z"/>\n  </g>\n</svg>\n'}),Et="lsp-set-column-visibility",Mt="lsp-jump-to-diagnostic",jt="lsp-copy-diagnostic",It="lsp-ignore-diagnostic-code",Tt="lsp-ignore-diagnostic-message",Lt=new class{constructor(e){this._content=null,this._widget=null,this.is_registered=!1,this.trans=e}get widget(){return null!=this._widget&&null!=this._widget.content.model||(this._widget&&!this._widget.isDisposed&&this._widget.dispose(),this._widget=this.initWidget()),this._widget}get content(){return this.widget.content}initWidget(){this._content=new Ct(new Ct.Model(this.trans)),this._content.model.diagnostics=new bt,this._content.addClass("lsp-diagnostics-panel-content");const e=new f.MainAreaWidget({content:this._content});return e.id="lsp-diagnostics-panel",e.title.label=this.trans.__("Diagnostics Panel"),e.title.closable=!0,e.title.icon=St,e}update(){this.widget.isAttached&&this.widget.content.update()}register(e){const t=this.widget;let n=e=>{for(let n of t.content.columns)if(n.id===e)return n},i=new lt.Menu({commands:e.commands});i.title.label=this.trans.__("Panel columns"),e.commands.addCommand(Et,{execute:e=>{let i=n(e.id);i.is_visible=!i.is_visible,t.update()},label:e=>this.trans.__(e.id),isToggled:e=>n(e.id).is_visible});for(let e of t.content.columns)i.addItem({command:Et,args:{id:e.id}});e.contextMenu.addItem({selector:".lsp-diagnostics-listing th",submenu:i,type:"submenu"});let s=new lt.Menu({commands:e.commands});s.title.label=this.trans.__("Ignore diagnostics like this");let o=()=>{let t=e.contextMenuHitTest((e=>"tr"==e.tagName.toLowerCase()));if(t)return this.widget.content.get_diagnostic(t.dataset.key)};s.addItem({command:It}),s.addItem({command:Tt}),e.commands.addCommand(It,{execute:()=>{const e=o().data.diagnostic;let t=this.content.model.settings.composite.ignoreCodes;this.content.model.settings.set("ignoreCodes",[...t,e.code]),this.feature.refreshDiagnostics()},isVisible:()=>{const e=o();return!!e&&!!e.data.diagnostic.code},label:()=>{const e=o();if(!e)return"";const t=e.data.diagnostic;return this.trans.__('Ignore diagnostics with "%1" code',t.code)}}),e.commands.addCommand(Tt,{execute:()=>{const e=o().data.diagnostic;let t=this.content.model.settings.composite.ignoreMessagesPatterns;var n;this.content.model.settings.set("ignoreMessagesPatterns",[...t,(n=e.message,n.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&"))]),this.feature.refreshDiagnostics()},isVisible:()=>{const e=o();return!!e&&!!e.data.diagnostic.message},label:()=>{const e=o();if(!e)return"";const t=e.data.diagnostic;return this.trans.__('Ignore diagnostics with "%1" message',t.message)}}),e.commands.addCommand(Mt,{execute:()=>{const e=o();this.widget.content.jump_to(e)},label:this.trans.__("Jump to location"),icon:ut}),e.commands.addCommand(jt,{execute:()=>{const e=o();if(!e)return;const t=e.data.diagnostic.message;navigator.clipboard.writeText(t).then((()=>{this.content.model.status_message.set(this.trans.__('Successfully copied "%1" to clipboard',t))})).catch((()=>{console.warn("Could not copy with clipboard.writeText interface, falling back"),window.prompt(this.trans.__("Your browser protects clipboard from write operations; please copy the message manually"),t)}))},label:this.trans.__("Copy diagnostics' message"),icon:de.copyIcon}),e.contextMenu.addItem({selector:".lsp-diagnostics-listing tbody tr",command:jt}),e.contextMenu.addItem({selector:".lsp-diagnostics-listing tbody tr",command:Mt}),e.contextMenu.addItem({selector:".lsp-diagnostics-listing tbody tr",submenu:s,type:"submenu"}),this.is_registered=!0}}(k.nullTranslator.load("jupyterlab_lsp")),Rt=new WeakMap;class At extends Be{constructor(){super(...arguments),this.marked_diagnostics=new Map,this.switchDiagnosticsPanelSource=()=>{Lt.trans=this.adapter.trans,Lt.content.model.virtual_editor===this.virtual_editor&&Lt.content.model.diagnostics==this.diagnostics_db||(Lt.content.model.diagnostics=this.diagnostics_db,Lt.content.model.virtual_editor=this.virtual_editor,Lt.content.model.adapter=this.adapter,Lt.content.model.settings=this.settings,Lt.content.model.status_message=this.status_message,Lt.feature=this,Lt.update())},this.handleDiagnostic=(e,t)=>{if((0,z.Ei)(t.uri,this.virtual_document.document_info.uri)&&0!==this.virtual_document.last_virtual_line)try{this.last_response=t,this.setDiagnostics(t),Lt.update()}catch(e){this.console.warn(e)}}}get settings(){return super.settings}register(){this.connection.serverNotifications["textDocument/publishDiagnostics"].connect(this.handleDiagnostic),this.wrapper_handlers.set("focusin",this.switchDiagnosticsPanelSource),this.unique_editor_ids=new z.Gl((()=>this.unique_editor_ids.size)),this.settings.changed.connect(this.refreshDiagnostics,this),this.adapter.adapterConnected.connect((()=>this.switchDiagnosticsPanelSource())),this.virtual_document.foreign_document_closed.connect(((e,t)=>{this.clearDocumentDiagnostics(t.foreign_document)})),super.register()}clearDocumentDiagnostics(e){this.diagnostics_db.set(e,[])}get diagnostics_db(){return Rt.has(this.virtual_editor)||Rt.set(this.virtual_editor,new bt),Rt.get(this.virtual_editor)}collapseOverlappingDiagnostics(e){const t=new Map,n=new Map;e.forEach((e=>{let i=e.range,s=function(e){return e.start.line+","+e.start.character+","+e.end.line+","+e.end.character}(i);t.set(s,i),n.has(s)?n.get(s).push(e):n.set(s,[e])}));let i=new Map;return n.forEach(((e,n)=>{let s=t.get(n);i.set(s,e)})),i}get defaultSeverity(){return De[this.settings.composite.defaultSeverity]}filterDiagnostics(e){const t=new Set(this.settings.composite.ignoreCodes),n=this.settings.composite.ignoreMessagesPatterns.map((e=>new RegExp(e)));return e.filter((e=>{let i=e.code;if(null!=i&&t.has(i.toString()))return!1;let s=e.message;return!s||!n.some((e=>e.test(s)))}))}setDiagnostics(e){let t=[];const n=new Set;this.collapseOverlappingDiagnostics(this.filterDiagnostics(e.diagnostics)).forEach(((i,s)=>{const o=P.lsp_to_cm(s.start),r=P.lsp_to_cm(s.end),a=this.virtual_document.last_virtual_line-this.virtual_document.blank_lines_between_cells;if(o.line>a)return void this.console.log(`Out of range diagnostic (${o.line} line > ${a}) was skipped `,i);{let e=this.virtual_document.last_line;if(o.line==a&&o.ch>e.length)return void this.console.log(`Out of range diagnostic (${o.ch} character > ${e.length} at line ${a}) was skipped `,i)}let l;try{let e=this.transform_virtual_position_to_root_position(o);l=this.virtual_editor.document_at_root_position(e)}catch(t){return void this.console.warn("Could not place inspections from "+e.uri," inspections: ",i,"error: ",t)}if(this.virtual_document!==l)return void this.console.log("Ignoring inspections from "+e.uri,` (this region is covered by a another virtual document: ${l.uri})`," inspections: ",i);if(-1!==l.virtual_lines.get(o.line).skip_inspect.indexOf(l.id_path))return void this.console.log("Ignoring inspections silenced for this document:",i);let c=i.map((e=>e.severity||this.defaultSeverity)).sort()[0];const d=De[c];let h,u=l.get_editor_at_virtual_line(o),_=this.virtual_editor.ce_editor_to_cm_editor.get(u),g=l.transform_virtual_to_editor(o);try{h=l.transform_virtual_to_editor(r)}catch(e){this.console.warn("Malformed range for diagnostic",r),h=Object.assign(Object.assign({},g),{ch:g.ch+1})}let p={start:g,end:h},m=JSON.stringify({diagnostics:i.map((e=>[e.severity,e.message,e.code,e.source,e.relatedInformation])),range:p,editor:this.unique_editor_ids.get(_)});for(let e of i)t.push({diagnostic:e,editor:_,range:p});if(n.add(m),!this.marked_diagnostics.has(m)){let e,t={title:i.map((e=>e.message+(e.source?" ("+e.source+")":""))).join("\n"),className:"cm-lsp-diagnostic cm-lsp-diagnostic-"+d};try{e=_.getDoc().markText(g,h,t)}catch(e){return void this.console.warn("Marking inspection (diagnostic text) failed:",i,e)}this.marked_diagnostics.set(m,e)}})),this.removeUnusedDiagnosticMarkers(n),this.diagnostics_db.set(this.virtual_document,t)}refreshDiagnostics(){this.last_response&&this.setDiagnostics(this.last_response),Lt.update()}removeUnusedDiagnosticMarkers(e){this.marked_diagnostics.forEach(((t,n)=>{e.has(n)||(this.marked_diagnostics.delete(n),t.clear())}))}remove(){this.settings.changed.disconnect(this.refreshDiagnostics,this),this.removeUnusedDiagnosticMarkers(new Set),this.diagnostics_db.clear(),Rt.delete(this.virtual_editor),this.unique_editor_ids.clear(),Lt.content.model.virtual_editor===this.virtual_editor&&(Lt.content.model.virtual_editor=null,Lt.content.model.diagnostics=null,Lt.content.model.adapter=null),Lt.update(),super.remove()}}const Pt=o+":diagnostics",Dt=e=>[{id:"show-diagnostics-panel",execute:({app:t,features:n,adapter:i})=>{n.get(Pt).switchDiagnosticsPanelSource(),Lt.is_registered||(Lt.trans=e,Lt.register(t));const s=Lt.widget;s.isAttached||t.shell.add(s,"main",{ref:i.widget_id,mode:"split-bottom"}),t.shell.activateById(s.id)},is_enabled:e=>"JupyterLab Classic"!=e.app.name,label:e.__("Show diagnostics panel"),rank:3,icon:St}],Ot={id:Pt,requires:[r,b.ISettingRegistry,k.ITranslator],autoStart:!0,activate:(e,t,n,i)=>{const s=new Ve(n,Pt),o=i.load("jupyterlab_lsp");t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",At]]),id:Pt,name:"LSP Diagnostics",settings:s,commands:Dt(o)}})}};var zt=n(7458);const $t=new de.LabIcon({name:"lsp:highlight",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M18.5 1.15c-.53 0-1.04.19-1.43.58l-5.81 5.82 5.65 5.65 5.82-5.81c.77-.78.77-2.04 0-2.83l-2.84-2.83c-.39-.39-.89-.58-1.39-.58M10.3 8.5l-5.96 5.96c-.78.78-.78 2.04.02 2.85C3.14 18.54 1.9 19.77.67 21h5.66l.86-.86c.78.76 2.03.75 2.81-.02l5.95-5.96"/>\n  </g>\n</svg>\n'}),Ht=new de.LabIcon({name:"lsp:highlight-type",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M18.5 1.15c-.53 0-1.04.19-1.43.58l-5.81 5.82 5.65 5.65 5.82-5.81c.77-.78.77-2.04 0-2.83l-2.84-2.83c-.39-.39-.89-.58-1.39-.58M10.3 8.5l-5.96 5.96c-.78.78-.78 2.04.02 2.85C3.14 18.54 1.9 19.77.67 21h5.66l.86-.86c.78.76 2.03.75 2.81-.02l5.95-5.96M18 16v2h2v8h2v-8h2v-2h-6z"/>\n  </g>\n</svg>\n'}),qt=e=>[{id:"highlight-references",execute:({connection:e,virtual_position:t,document:n})=>e.getReferences(t,n.document_info),is_enabled:({connection:e})=>e.isReferencesSupported(),label:e.__("Highlight references"),icon:$t},{id:"highlight-type-definition",execute:({connection:e,virtual_position:t,document:n})=>e.getTypeDefinition(t,n.document_info),is_enabled:({connection:e})=>e.isTypeDefinitionSupported(),label:e.__("Highlight type definition"),icon:Ht}];class Ft extends Be{constructor(){super(...arguments),this.highlight_markers=[],this.onBlur=()=>{this.settings.composite.removeOnBlur?(this.clear_markers(),this.last_token=null):this.onCursorActivity().catch(console.warn)},this.handleHighlight=e=>{if(this.clear_markers(),e)for(let t of e){let e=this.range_to_editor_range(t.range),n=t.kind?"cm-lsp-highlight-"+ze[t.kind]:"",i=this.highlight_range(e,"cm-lsp-highlight "+n);this.highlight_markers.push(i)}},this.on_cursor_activity=async()=>(this.sent_version=this.virtual_document.document_info.version,await this.connection.getDocumentHighlights(this.virtual_position,this.virtual_document.document_info,!1)),this.onCursorActivity=async()=>{var e,t;if(!(null===(t=null===(e=this.virtual_editor)||void 0===e?void 0:e.virtual_document)||void 0===t?void 0:t.document_info))return;let n;await this.virtual_editor.virtual_document.update_manager.update_done;try{n=this.virtual_editor.getDoc().getCursor("start")}catch(e){return void this.console.warn("no root position available")}if(null==n)return void this.console.warn("no root position available");const i=this.virtual_editor.get_token_at(n);if(this.last_token&&i.value===this.last_token.value&&""!==i.value)return void this.console.log("not requesting highlights (token did not change)",i);let s;try{s=this.virtual_editor.document_at_root_position(n)}catch(e){return void this.console.warn("Could not obtain virtual document from position",n)}if(s===this.virtual_document)try{let e=this.virtual_editor.root_position_to_virtual_position(n);this.virtual_position=e,Promise.all([this.debounced_get_highlight.invoke(),async()=>{this.clear_markers(),this.last_token=null}]).then((([t])=>{if(this.virtual_document.isDisposed)return;let n=this.virtual_document.document_info.version;n===this.sent_version?e===this.virtual_position?(this.handleHighlight(t),this.last_token=i):this.console.log("skipping highlights response: cursor moved since it was requested"):this.console.log("skipping highlights response delayed by "+(n-this.sent_version)+" document versions")})).catch(this.console.warn)}catch(e){this.console.warn("Could not get highlights:",e)}}}get settings(){return super.settings}register(){this.debounced_get_highlight=this.create_debouncer(),this.settings.changed.connect((()=>{this.debounced_get_highlight=this.create_debouncer()})),this.editor_handlers.set("cursorActivity",this.onCursorActivity),this.editor_handlers.set("blur",this.onBlur),this.editor_handlers.set("focus",this.onCursorActivity),super.register()}remove(){this.handleHighlight=null,this.onCursorActivity=null,this.clear_markers(),super.remove()}clear_markers(){for(let e of this.highlight_markers)e.clear();this.highlight_markers=[]}create_debouncer(){return new zt.dx(this.on_cursor_activity,this.settings.composite.debouncerDelay)}}const Nt=o+":highlights",Wt={id:Nt,requires:[r,b.ISettingRegistry,k.ITranslator],autoStart:!0,activate:(e,t,n,i)=>{const s=new Ve(n,Nt),o=i.load("jupyterlab_lsp");t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",Ft]]),id:Nt,name:"LSP Highlights",settings:s,commands:qt(o)}})}};var Vt=n(5174);class Ut extends Vt.Tooltip{constructor(e){super(e),this.options=e,this._setGeometry();const t=new Ne.MimeModel({data:e.bundle});this._content.renderModel(t).then((()=>this._setGeometry())).catch(console.warn)}handleEvent(e){if(this.isHidden||this.isDisposed)return;const{node:t}=this,n=e.target;switch(e.type){case"keydown":{const i=e.keyCode;if(t.contains(n)||!this.options.hideOnKeyPress&&27!=i&&8!=i)return;this.dispose();break}default:super.handleEvent(e)}}_setGeometry(){const e=this._editor,t=null==this.options.position?e.getCursorPosition():this.options.position,n=e.getOffsetAt(t),i=e.getLine(t.line);if(!i)return;let s;switch(this.options.alignment){case"start":{const t=i.substring(0,n).split(/\W+/),o=t[t.length-1],r=o?n-o.length:n;s=e.getPositionAt(r);break}case"end":{const t=i.substring(0,n).split(/\W+/),o=t[t.length-1],r=o?n-o.length:n;s=e.getPositionAt(r);break}default:s=t}if(!s)return;const o=e.getCoordinateForPosition(s),r=window.getComputedStyle(this.node),a=parseInt(r.paddingLeft,10)||0;f.HoverBox.setGeometry({anchor:o,host:e.host,maxHeight:250,minHeight:20,node:this.node,offset:{horizontal:-1*a},privilege:this.options.privilege||"below",style:r})}}class Bt{constructor(e){this.rendermime_registry=e,this.currentTooltip=null}create(e){this.remove(),this.currentOptions=e;let{markup:t,position:n,adapter:i}=e,s=i.widget;const o="plaintext"===t.kind?{"text/plain":t.value}:{"text/markdown":t.value},r=new Ut(Object.assign(Object.assign({},e.tooltip||{}),{anchor:s.content,bundle:o,editor:e.ce_editor,rendermime:this.rendermime_registry,position:P.cm_to_ce(n)}));return r.addClass("lsp-tooltip"),r.addClass(e.className),lt.Widget.attach(r,document.body),this.currentTooltip=r,r}get position(){return this.currentOptions.position}isShown(e){var t;return(!e||!this.currentOptions||(null===(t=this.currentOptions)||void 0===t?void 0:t.id)===e)&&this.currentTooltip&&!this.currentTooltip.isDisposed&&this.currentTooltip.isVisible}remove(){null!==this.currentTooltip&&(this.currentTooltip.dispose(),this.currentTooltip=null)}}new de.LabIcon({name:"lsp:hover",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M11 18h2v-2h-2v2m1-12a4 4 0 00-4 4h2a2 2 0 012-2 2 2 0 012 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5a4 4 0 00-4-4M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z"/>\n  </g>\n</svg>\n'});class Zt{constructor(e){this.maxSize=e,this._data=[]}get data(){return this._data}store(e){const t=this._data.findIndex((t=>t.document===e.document&&h(t.editor_range.start,e.editor_range.start)&&h(t.editor_range.end,e.editor_range.end)&&t.editor_range.editor===e.editor_range.editor));-1===t?(this._data.length>=this.maxSize&&this._data.shift(),this._data.push(e)):this._data[t]=e}clean(){this._data=[]}}function Kt(e){return"string"==typeof e?{kind:"markdown",value:e}:{kind:"markdown",value:"```"+e.language+"\n"+e.value+"\n```"}}class Jt extends Be{constructor(e){super(e),this.onKeyDown=e=>{if((0,z.nE)(e,this.modifierKey)&&void 0!==this.last_hover_character){if(this.tooltip&&this.tooltip.isVisible&&!this.tooltip.isDisposed)return;const t=this.virtual_editor.document_at_root_position(this.last_hover_character);let n=this.restore_from_cache(t,this.virtual_position);if(null==n)return;e.stopPropagation(),this.handleResponse(n,this.last_hover_character,!0)}},this.onMouseLeave=e=>{this.remove_range_highlight(),this.maybeHideTooltip(e)},this.on_hover=async()=>{var e;if(!this.connection.isReady||!(null===(e=this.connection.serverCapabilities)||void 0===e?void 0:e.hoverProvider))return;let t=this.virtual_position;return await this.connection.clientRequests["textDocument/hover"].request({textDocument:{uri:this.virtual_document.document_info.uri},position:{line:t.line,character:t.ch}})},this.handleResponse=(e,t,n)=>{let i=e.response;if(this.last_hover_response!=i&&(this.remove_range_highlight(),this.hover_marker=this.highlight_range(e.editor_range,"cm-lsp-hover-available")),this.last_hover_response=i,n){this.lab_integration.tooltip.remove();const n=Jt.get_markup_for_hover(i);let s=this.virtual_editor.root_position_to_editor(t);return this.tooltip=this.lab_integration.tooltip.create({markup:n,position:s,ce_editor:e.ce_editor,adapter:this.adapter,className:"lsp-hover"}),!0}return!1},this.updateUnderlineAndTooltip=e=>{try{return this._updateUnderlineAndTooltip(e)}catch(e){"Cell not found in cell_line_map"!==e.message&&"Cannot read property 'string' of undefined"!==e.message&&this.console.warn(e)}},this.remove_range_highlight=()=>{this.hover_marker&&(this.hover_marker.clear(),this.hover_marker=null,this.last_hover_response=void 0,this.last_hover_character=void 0)},this._previousHoverRequest=null}get modifierKey(){return this.settings.composite.modifierKey}get lab_integration(){return super.lab_integration}get settings(){return super.settings}restore_from_cache(e,t){const{line:n,ch:i}=t,s=this.cache.data.filter((t=>{if(t.document!==e)return!1;let s=t.response.range;return n>=s.start.line&&n<=s.end.line&&(n!=s.start.line||i>s.start.character)&&(n!=s.end.line||i<=s.end.character)}));return s.length>1&&this.console.warn("Potential hover cache malfunction: ",t,s),0!=s.length?s[0]:null}register(){this.cache=new Zt(this.settings.composite.cacheSize),this.wrapper_handlers.set("mousemove",(e=>{this.updateUnderlineAndTooltip(e).then((t=>{t||this.maybeHideTooltip(e)})).catch(this.console.warn)})),this.wrapper_handlers.set("mouseleave",this.onMouseLeave),this.wrapper_handlers.set("keydown",this.onKeyDown),this.editor_handlers.set("keydown",((e,t)=>this.onKeyDown(t))),this.debounced_get_hover=this.create_throttler(),this.settings.changed.connect((()=>{this.cache.maxSize=this.settings.composite.cacheSize,this.debounced_get_hover=this.create_throttler()})),super.register()}maybeHideTooltip(e){void 0===this.tooltip||function(e,t,n=50){const i="mouseleave"===t.type?t.relatedTarget:t.target;if(e===i||e.contains(i))return!0;const s=e.getBoundingClientRect();return!(t.x<s.left-n||t.x>s.right+n||t.y<s.top-n||t.y>s.bottom+n)}(this.tooltip.node,e)||this.tooltip.dispose()}create_throttler(){return new zt.eD(this.on_hover,{limit:this.settings.composite.throttlerDelay,edge:"trailing"})}afterChange(e,t){super.afterChange(e,t),this.cache.clean(),this.last_hover_character=void 0,this.remove_range_highlight()}static get_markup_for_hover(e){let t=e.contents;if("string"==typeof t&&(t=[t]),!Array.isArray(t))return t;let n=t.map(Kt);return n.every((e=>"plaintext"==e.kind))?{kind:"plaintext",value:n.map((e=>e.value)).join("\n")}:{kind:"markdown",value:n.map((e=>e.value)).join("\n\n")}}is_token_empty(e){return 0===e.string.length}is_event_inside_visible(e){return null!=e.target.closest(".CodeMirror-sizer")}is_useful_response(e){return e&&e.contents&&!(Array.isArray(e.contents)&&0===e.contents.length)}async _updateUnderlineAndTooltip(e){if(e.target.classList.contains("CodeMirror-line"))return void this.remove_range_highlight();const t=(0,z.nE)(e,this.modifierKey);let n=this.position_from_mouse(e);if(null==n)return void this.remove_range_highlight();let i=this.virtual_editor.getTokenAt(n),s=this.virtual_editor.document_at_root_position(n);if(!this.is_token_empty(i)&&s===this.virtual_document&&this.is_event_inside_visible(e)){if(h(n,this.last_hover_character))return!0;{let e=this.virtual_editor.root_position_to_virtual_position(n);this.virtual_position=e,this.last_hover_character=n,this._previousHoverRequest&&await Promise.race([this._previousHoverRequest,new Promise((e=>setTimeout(e,1e3)))]);let o=this.restore_from_cache(s,e);if(null==o){const e=this.debounced_get_hover.invoke();this._previousHoverRequest=e;let t=await e;if(this._previousHoverRequest===e&&(this._previousHoverRequest=null),!this.is_useful_response(t))return void this.remove_range_highlight();{let e=this.virtual_editor.get_editor_at_root_position(n),r=this.virtual_editor.ce_editor_to_cm_editor.get(e),a=this.get_editor_range(t,n,i,r);o={response:this.add_range_if_needed(t,a,e),document:s,editor_range:a,ce_editor:e},this.cache.store(o)}}return this.handleResponse(o,n,t)}}this.remove_range_highlight()}remove(){this.cache.clean(),this.remove_range_highlight(),this.debounced_get_hover.dispose(),super.remove(),this.debounced_get_hover=null,this.remove_range_highlight=null,this.handleResponse=null,this.on_hover=null}get_editor_range(e,t,n,i){if(void 0!==e.range)return this.range_to_editor_range(e.range,i);let s={line:t.line,ch:n.start},o={line:t.line,ch:n.end};return{start:this.virtual_editor.root_position_to_editor(s),end:this.virtual_editor.root_position_to_editor(o),editor:i}}add_range_if_needed(e,t,n){return void 0!==e.range?e:Object.assign(Object.assign({},e),{range:{start:P.cm_to_lsp(this.virtual_editor.root_position_to_virtual_position(this.virtual_editor.transform_from_editor_to_root(n,t.start))),end:P.cm_to_lsp(this.virtual_editor.root_position_to_virtual_position(this.virtual_editor.transform_from_editor_to_root(n,t.end)))}})}}class Gt{constructor(e,t,n){this.tooltip=new Bt(n)}}const Xt=o+":hover",Yt={id:Xt,requires:[r,b.ISettingRegistry,Ne.IRenderMimeRegistry],autoStart:!0,activate:(e,t,n,i)=>{const s=new Ve(n,Xt),o=new Gt(e,s,i);t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",Jt]]),id:Xt,name:"LSP Hover tooltip",labIntegration:o,settings:s}})}},Qt=new de.LabIcon({name:"lsp:rename",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M17 7h5v10h-5v2a1 1 0 001 1h2v2h-2.5c-.55 0-1.5-.45-1.5-1 0 .55-.95 1-1.5 1H12v-2h2a1 1 0 001-1V5a1 1 0 00-1-1h-2V2h2.5c.55 0 1.5.45 1.5 1 0-.55.95-1 1.5-1H20v2h-2a1 1 0 00-1 1v2M2 7h11v2H4v6h9v2H2V7m18 8V9h-3v6h3z"/>\n  </g>\n</svg>\n'}),en=o+":rename",tn=e=>[{id:"rename-symbol",execute:async({editor:t,connection:n,virtual_position:i,document:s,features:o})=>{const r=o.get(en);r.setTrans(e);let a=r.transform_virtual_position_to_root_position(i),l=t.get_token_at(a).value;const c=await f.InputDialog.getText({title:e.__("Rename to"),text:l,okLabel:e.__("Rename"),cancelLabel:e.__("Cancel")});try{if(1!=c.button.accept)return;let t=c.value;r.setStatus(e.__("Renaming %1 to %2...",l,t),2e3);const o=await n.rename(i,s.document_info,t,!1);await r.handleRename(o,l,t)}catch(n){(n=>{let i="";if(o.has(Pt)){let e=o.get(Pt);i=nn.ux_workaround_for_rope_limitation(n,e,t,r)}i||(i=e.__("Rename failed: %1",n)),r.setStatus(i,7500)})(n)}},is_enabled:({connection:e})=>e.isRenameSupported(),label:e.__("Rename symbol"),icon:Qt}];class nn extends Be{setTrans(e){this.trans=e}setStatus(e,t){return this.status_message.set(e,t)}async handleRename(e,t,n){let i;try{i=await this.apply_edit(e)}catch(e){return this.status_message.set(this.trans.__("Rename failed: %1",e)),i}try{let e;const s=this.trans.__("%1 to %2",t,n);e=0===i.appliedChanges?this.trans.__("Could not rename %1 - consult the language server documentation",s):i.wasGranular?this.trans._n("Renamed %2 in %3 place","Renamed %2 in %3 places",i.appliedChanges,s,i.appliedChanges):this.adapter.has_multiple_editors?this.trans._n("Renamed %2 in %3 cell","Renamed %2 in %3 cells",i.modifiedCells,s,i.modifiedCells):this.trans.__("Renamed %1",s),0!==i.errors.length&&(e+=this.trans.__(" with errors: %1",i.errors)),this.status_message.set(e,5e3)}catch(e){this.console.warn(e)}return i}static ux_workaround_for_rope_limitation(e,t,n,i){let s=!1;try{s=e.message.includes("IndexError")}catch(e){return null}if(!s)return null;let o=(t.diagnostics_db.all||[]).filter((e=>e.diagnostic.message.includes("invalid syntax")||e.diagnostic.message.includes("SyntaxError")||e.diagnostic.message.includes("IndentationError")));if(0===o.length)return null;let r=[...new Set(o.map((e=>{let t=e.diagnostic.message,s=e.range.start;if(i.adapter.has_multiple_editors){let{index:o}=n.find_editor(e.editor),r=o+1;return i.trans.__("%1 in cell %2 at line %3",t,r,s.line)}return i.trans.__("%1 at line %2",t,s.line)})))].join(", ");return i.trans.__("Syntax error(s) prevent rename: %1",r)}}const sn={id:en,requires:[r,b.ISettingRegistry,k.ITranslator],autoStart:!0,activate:(e,t,n,i)=>{const s=(i||k.nullTranslator).load("jupyterlab_lsp"),o=new Ve(n,en);t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",nn]]),id:en,name:"LSP Rename",settings:o,commands:tn(s)}})}},on="signature";function rn(e){return"string"==typeof e?(0,z.ry)(e):"markdown"===e.kind?e.value:(0,z.ry)(e.value)}class an extends Be{get settings(){return super.settings}get _closeCharacters(){return this.settings?this.settings.composite.closeCharacters:[]}register(){this.editor_handlers.set("cursorActivity",this.onCursorActivity.bind(this)),this.editor_handlers.set("blur",this.onBlur.bind(this)),this.editor_handlers.set("focus",this.onCursorActivity.bind(this)),super.register()}onBlur(e,t){this.isSignatureShown()&&null===t.target.closest(".lsp-signature-help")&&this._hideTooltip()}onCursorActivity(){if(!this.isSignatureShown())return;const e=this.virtual_editor.get_cursor_position(),t=this.lab_integration.tooltip.position;let n=this.virtual_editor.root_position_to_editor(e);n.line===t.line&&n.ch<t.ch?this._hideTooltip():this.requestSignature(e,t).catch(this.console.warn)}get lab_integration(){return super.lab_integration}get_markup_for_signature_help(e,t){let n=new Array;if(null!=e.activeSignature){if(!(e.activeSignature>=e.signatures.length)){const n=e.signatures[e.activeSignature];return{kind:"markdown",value:this.signatureToMarkdown(n,t,e.activeParameter)}}this.console.error("LSP server returned wrong number for activeSignature for: ",e)}return e.signatures.forEach((e=>{let i=this.signatureToMarkdown(e,t);n.push(i)})),{kind:"markdown",value:n.join("\n\n")}}highlightCode(e,t,n){const i=document.createElement("pre"),s=document.createElement("code");return i.appendChild(s),s.className="cm-s-jupyter language-"+n,this.lab_integration.codeMirror.CodeMirror.runMode(e,n,((e,n)=>{let i;if(n?(i=document.createElement("span"),i.classList.add("cm-"+n),i.textContent=e):i=document.createTextNode(e),"variable"===n&&e===t){const e=document.createElement("mark");e.appendChild(i),i=e}s.appendChild(i)})),i.outerHTML+"\n\n"}signatureToMarkdown(e,t,n){return function(e,t,n,i,s,o=4){const r=void 0!==e.activeParameter?e.activeParameter:s;let a,l=e.label;if(e.parameters&&null!=r)if(r>e.parameters.length)i.error("LSP server returned wrong number for activeSignature for: ",e),a="```"+t+"\n"+l+"\n```";else{const i=e.parameters[r];let s="string"==typeof i.label?i.label:l.slice(i.label[0],i.label[1]);a=n(l,s,t)}else a="```"+t+"\n"+l+"\n```";let c="";if(e.documentation)if(c+="\n","string"==typeof e.documentation||"plaintext"===e.documentation.kind){const t="string"==typeof e.documentation?e.documentation:e.documentation.value;for(let n of t.split("\n"))n.trim()!==e.label.trim()&&(c+=rn(n)+"\n")}else"markdown"!==e.documentation.kind&&this.console.warn("Unknown MarkupContent kind:",e.documentation.kind),c+=e.documentation.value;else e.parameters&&(c+="\n\n"+e.parameters.filter((e=>e.documentation)).map((e=>"- "+rn(e.documentation))).join("\n"));if(c){const e=c.trim().split("\n");if(e.length>o){const t=function(e,t){const n=[];let i=!1;for(const s of e.slice(0,t+1)){if(""==s.trim()){i=!0;break}n.push(s)}const s=n.join("\n");return i&&-1===s.search(/[\\*#[\]<>_]/g)?{lead:s,remainder:e.slice(n.length+1).join("\n")}:null}(e,o);c=t?t.lead+"\n<details>\n"+t.remainder+"\n</details>":"<details>\n"+c+"\n</details>"}a+=c}return a}(e,t,this.highlightCode.bind(this),this.console,n,this.settings.composite.maxLines)}_hideTooltip(){this.lab_integration.tooltip.remove()}handleSignature(e,t,n=null){if(this.console.log("Signature received",e),(e||null===e)&&this._hideTooltip(),!this.signatureCharacter||!e||!e.signatures.length)return void this.console.debug("Ignoring signature response: cursor lost or response empty");let i=this.virtual_editor.get_cursor_position();(t.line!=i.line||i.ch<t.ch)&&this.console.debug("Ignoring signature response: cursor has receded or changed line");let s=this.get_cm_editor(i);if(!s.hasFocus())return void this.console.debug("Ignoring signature response: the corresponding editor lost focus");let o=this.virtual_editor.root_position_to_editor(i),r=this.get_language_at(o,s),a=this.get_markup_for_signature_help(e,r);this.console.log("Signature will be shown",r,a,i,e),this.lab_integration.tooltip.create({markup:a,position:null===n?o:n,id:on,ce_editor:this.virtual_editor.find_ce_editor(s),adapter:this.adapter,className:"lsp-signature-help",tooltip:{privilege:"forceAbove",alignment:"start",hideOnKeyPress:!1}})}get signatureCharacters(){var e;return(null===(e=this._signatureCharacters)||void 0===e?void 0:e.length)||(this._signatureCharacters=this.connection.getLanguageSignatureCharacters()),this._signatureCharacters}isSignatureShown(){return this.lab_integration.tooltip.isShown(on)}afterChange(e,t){let n=this.extract_last_character(e);const i=this.isSignatureShown();let s=null;i&&(s=this.lab_integration.tooltip.position,this._closeCharacters.includes(n)&&this._hideTooltip()),(this.signatureCharacters.includes(n)||i)&&this.requestSignature(t,s).catch(this.console.warn)}requestSignature(e,t){var n;if(!this.connection.isReady||!(null===(n=this.connection.serverCapabilities)||void 0===n?void 0:n.signatureHelpProvider))return;this.signatureCharacter=e;let i=this.virtual_editor.root_position_to_virtual_position(e);return this.connection.clientRequests["textDocument/signatureHelp"].request({position:{line:i.line,character:i.ch},textDocument:{uri:this.virtual_document.document_info.uri}}).then((n=>this.handleSignature(n,e,t)))}}class ln{constructor(e,t,n,i){this.codeMirror=i,this.tooltip=new Bt(n)}}const cn=o+":signature",dn={id:cn,requires:[r,b.ISettingRegistry,Ne.IRenderMimeRegistry,ct.ICodeMirror],autoStart:!0,activate:(e,t,n,i,s)=>{const o=new Ve(n,cn),r=new ln(e,o,i,s);t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",an]]),id:cn,name:"LSP Function signature",labIntegration:r,settings:o}})}};var hn=n(1766);new de.LabIcon({name:"lsp:syntax-highlighting",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M10.48 10.88l3.68-3.68-3.68-3.68L11.6 2.4l4.8 4.8-4.8 4.8-1.12-1.12m-4.16 0L2.64 7.2l3.68-3.68L5.2 2.4.4 7.2 5.2 12l1.12-1.12zM8.5 23.8l2.337-2.338-.025-.017a1.283 1.283 0 010-1.802l4.029-4.029 3.604 3.604-4.029 4.03a1.267 1.267 0 01-1.776.017l-.536.535H8.5m10.124-11.976a1.283 1.283 0 011.802 0l1.81 1.802a1.293 1.293 0 010 1.81l-2.805 2.796-3.604-3.604 2.797-2.805z"/>\n  </g>\n</svg>\n'});const un=o+":syntax_highlighting";class _n extends Be{constructor(e){super(e),this.virtual_document.changed.connect(this.update_mode.bind(this),this),this.editors_with_active_highlight=new Set}get lab_integration(){return super.lab_integration}get settings(){return super.settings}get_mode(e){let t=this.lab_integration.mimeTypeService.getMimeTypeByLanguage({name:e});if(t&&"text/plain"!=t)return this.lab_integration.codeMirror.CodeMirror.findModeByMIME(t)}update_mode(){let e=this.virtual_document,t=new Set;for(let n of e.foreign_document_maps)for(let[e,i]of n.entries()){let n=i.editor,s=n.editor,o=s.getValue("\n").concat("").length,r=(n.getOffsetAt(e.end)-n.getOffsetAt(e.start))/o,a=i.virtual_document.language,l=this.get_mode(a);void 0!==l&&r>this.settings.composite.foreignCodeThreshold&&(t.add(n),s.getOption("mode")!=l.mime&&s.setOption("mode",l.mime))}if(t!=this.editors_with_active_highlight)for(let e of this.editors_with_active_highlight)t.has(e)||e.editor.setOption("mode",e.model.mimeType);this.editors_with_active_highlight=t}}class gn{constructor(e,t){this.mimeTypeService=e,this.codeMirror=t}}const pn={id:un,requires:[r,hn.IEditorServices,b.ISettingRegistry,ct.ICodeMirror,k.ITranslator],autoStart:!0,activate:(e,t,n,i,s,o)=>{const r=new Ve(i,un),a=o.load("jupyterlab_lsp");t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",_n]]),commands:[],id:un,name:a.__("Syntax highlighting"),labIntegration:new gn(n.mimeTypeService,s),settings:r}})}};var mn=n(5890);class vn{constructor(e){this._sessionsChanged=new M.Signal(this),this._sessions=new Map,this._specs=new Map,this._warningsEmitted=new Set,this._settings=e.settings||mn.ServerConnection.makeSettings(),this._baseUrl=e.baseUrl||O.PageConfig.getBaseUrl(),this._retries=e.retries||2,this._retriesInterval=e.retriesInterval||1e4,this._statusCode=null,this._configuration={},this.console=e.console,this.fetchSessions().catch(console.warn)}get specs(){return this._specs}get statusUrl(){return O.URLExt.join(this._baseUrl,i.URL_NS,"status")}get sessionsChanged(){return this._sessionsChanged}get sessions(){return this._sessions}setConfiguration(e){this._configuration=e}warnOnce(e){this._warningsEmitted.has(e)||(this._warningsEmitted.add(e),this.console.warn(e))}_comparePriorities(e,t){var n,i,s,o;const r=null!==(i=null===(n=this._configuration[e])||void 0===n?void 0:n.priority)&&void 0!==i?i:50,a=null!==(o=null===(s=this._configuration[t])||void 0===s?void 0:s.priority)&&void 0!==o?o:50;return r==a?(this.warnOnce(`Two matching servers: ${e} and ${t} have the same priority; choose which one to use by changing the priority in Advanced Settings Editor`),e.localeCompare(t)):a-r}isMatchingSpec(e,t){const n=e.language.toLocaleLowerCase();return t.languages.some((e=>e.toLocaleLowerCase()==n))}getMatchingServers(e){if(!e.language)return this.console.error("Cannot match server by language: language not available; ensure that kernel and specs provide language and MIME type"),[];const t=[];for(const[n,i]of this._sessions.entries())this.isMatchingSpec(e,i.spec)&&t.push(n);return t.sort(this._comparePriorities.bind(this))}getMatchingSpecs(e){const t=new Map;for(const[n,i]of this._specs.entries())this.isMatchingSpec(e,i)&&t.set(n,i);return t}get statusCode(){return this._statusCode}async fetchSessions(){let e,t=await mn.ServerConnection.makeRequest(this.statusUrl,{method:"GET"},this._settings);if(this._statusCode=t.status,!t.ok)return console.error("Could not fetch sessions",t),void(this._retries>0&&(this._retries-=1,setTimeout(this.fetchSessions.bind(this),this._retriesInterval)));try{const n=await t.json();e=n.sessions;try{this._version=n.version,this._specs=new Map(Object.entries(n.specs))}catch(e){console.warn(e)}}catch(e){return void console.warn(e)}for(let t of Object.keys(e)){let n=t;this._sessions.has(n)?Object.assign(this._sessions.get(n),e[t]):this._sessions.set(n,e[t])}const n=this._sessions.keys();for(const t in n)if(!e[t]){let e=t;this._sessions.delete(e)}this._sessionsChanged.emit(void 0)}}class fn{constructor(){this._overrides={}}get registry(){return this._overrides}register(e,t){t in this._overrides||(this._overrides[t]={cell:[],line:[]});let n=this._overrides[t];switch(e.scope){case"cell":n.cell.push(e);break;case"line":n.line.push(e)}}}const wn={id:m.name,requires:[],activate:e=>new fn,provides:m,autoStart:!0};let yn={python:[new p({language:"python",pattern:"^%%(python|python2|python3|pypy)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!0,file_extension:"py"}),new p({language:"perl",pattern:"^%%(perl)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!0,file_extension:"pl"}),new p({language:"ruby",pattern:"^%%(ruby)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!0,file_extension:"rb"}),new p({language:"sh",pattern:"^%%(sh|bash)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!0,file_extension:"sh"}),new p({language:"html",pattern:"^%%(html --isolated)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!0,file_extension:"html"}),new p({language:"javascript",pattern:"^%%(js|javascript)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!1,file_extension:"js"}),new p({language:"html",pattern:"^%%(?!html --isolated)(html)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!1,file_extension:"html"}),new p({language:"latex",pattern:"^%%(latex)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!1,file_extension:"tex"}),new p({language:"markdown",pattern:"^%%(markdown)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!1,file_extension:"md"})]};function bn(e){return e.replace(/\\([\\"])/g,"$1")}function xn(e){return e?function(e){return e.replace(/(["\\])/g,"\\$1")}(e):""}const kn="^(\\s*|\\s*\\S+\\s*=\\s*)";let Cn=[{pattern:kn+"!([^=\\s]+)(.*)(\n)?",replacement:'$1get_ipython().getoutput("$2$3")$4',scope:"line",reverse:{pattern:'get_ipython\\(\\).getoutput\\("(.*?)"\\)(\n)?',replacement:"!$1$2",scope:"line"}},{pattern:"^(\\s*)(\\?{1,2})([^?\\s'\"\\(\\)-\\+\\/#]+)(\n)?$",replacement:(e,t,n,i,s)=>`${t}get_ipython().run_line_magic('${"?"==n?"pinfo":"pinfo2"}', '${i}')${s=s||""}`,scope:"line",reverse:{pattern:"get_ipython\\(\\).run_line_magic\\('(pinfo2?)', '(.*?)'\\)(\n)?",replacement:(e,t,n)=>`${"pinfo"==t?"?":"??"}${n}`,scope:"line"}},{pattern:"^(\\s*)([^?\\s'\"\\(\\)-\\+\\/#]+)(\\?{1,2})(\n)?",replacement:(e,t,n,i,s)=>`${t}get_ipython().run_line_magic('${"?"==i?"pinfo":"pinfo2"}',  '${n}')${s=s||""}`,scope:"line",reverse:{pattern:"get_ipython\\(\\).run_line_magic\\('(pinfo2?)',  '(.*?)'\\)(\n)?",replacement:(e,t,n)=>`${n}${"pinfo"==t?"?":"??"}`,scope:"line"}},{pattern:kn+"%(\\S+)(.*)(\n)?",replacement:(e,t,n,i,s)=>`${t}get_ipython().run_line_magic("${n}", "${i=xn(i)}")${s=s||""}`,scope:"line",reverse:{pattern:'get_ipython\\(\\).run_line_magic\\("(.*?)", "(.*?)"\\)(\n)?',replacement:(e,t,n)=>`%${t}${n=bn(n)}`,scope:"line"}},{pattern:"^%%(\\S+)(.*\n)([\\s\\S]*)",replacement:(e,t,n,i,s,o)=>((n=xn(n))&&(n=n.slice(0,-1)),`get_ipython().run_cell_magic("${t}", "${n}", """${i=i.replace(/"""/g,'\\"\\"\\"')}""")`),scope:"cell",reverse:{pattern:'^get_ipython\\(\\).run_cell_magic\\("(.*?)", "(.*?)", """([\\s\\S]*)"""\\)',replacement:(e,t,n,i)=>(i=i.replace(/\\"\\"\\"/g,'"""'),`%%${t}${n=bn(n)}\n${i}`),scope:"cell"}}];const Sn={id:o+":ipython",requires:[c,m],activate:(e,t,n)=>{for(let e of Object.keys(yn))for(let n of yn[e])t.register(n,e);for(let e of Cn)n.register(e,"python")},autoStart:!0},En="(?:"+["-l","--connections"].join("|")+"|"+["--destination_table","--project","--use_bqstorage_api","--use_rest_api","--use_legacy_sql","--verbose","--params"].map((e=>e+" \\w+")).join("|")+")";let Mn={python:[new p({language:"sql",pattern:`^%%bigquery(?: (?:(?:(?:.*?)://(?:.*))|${En}|(?:\\w+ << )|(?:\\w+@\\w+)))?\n?((?:.+\n)?(?:[^]*))`,foreign_capture_groups:[1],is_standalone:!0,file_extension:"sql"})]};const jn={id:o+":ipython-bigquery",requires:[c],activate:(e,t)=>{for(let e of Object.keys(Mn))for(let n of Mn[e])t.register(n,e)},autoStart:!0};function In(e,t){let n=[],i=[],s=[];for(let t=0;t<e.length;t+=2){let o=e[t],r=e[t+1];if(null==o)break;"i"===o||"-input"===o?n.push(r):"o"===o||"-output"===o?i.push(r):s.push("-"+o+" "+r)}return{inputs:n,outputs:i,rest:e[e.length+t],others:s}}function Tn(e,t){let{inputs:n,outputs:i,rest:s,others:o}=In(e,t),r=n.join(", ");r&&(r=", "+r);let a=i.join(", ");return a&&(a+=" = "),{content:s,others:o.join(" "),inputs:r,outputs:a}}function Ln(e='"',t=!1,n="R"){return"(\\S+)?"+"(?:, (\\S+))?".repeat(9)+"( = )?rpy2\\.ipython\\.rmagic\\.RMagics."+n+"\\("+e+(t?"([\\s\\S]*)":"(.*?)")+e+', "(.*?)"'+"(?:, (\\S+))?".repeat(10)+"\\)"}function Rn(e,...t){let n=[];for(let e=0;e<10&&null!=t[e];e++)n.push(t[e]);let i=[];for(let e=13;e<23&&null!=t[e];e++)i.push(t[e]);let s=i.join(" -i ");s&&(s=" -i "+s);let o=n.join(" -o ");o&&(o=" -o "+o);let r=t[11],a=t[12];return a&&(a=" "+a),{input:s,output:o,other:a,contents:r}}function An(e){return"(?: -(\\S+) (\\S+))?".repeat(e)}function Pn(e){return function(t,...n){let i,s=In(n,-3);return i=null==s.rest?"":e&&s.rest.startsWith(" ")?s.rest.slice(1):s.rest,i}}let Dn=Pn(!1);function On(e,...t){let n=In(t,-3).inputs.map((e=>e+" <- data.frame();")).join(" "),i=Dn(e,...t);return""!==n&&i&&(n+=" "),n}let zn={python:[new p({language:"r",pattern:"^%%R"+An(10)+"\n([^]*)",foreign_capture_groups:[21],foreign_replacer:Dn,extract_arguments:On,is_standalone:!1,file_extension:"R"}),new p({language:"r",pattern:"(?:^|\n)%R"+An(10)+"(?: (.*))?(?:\n|$)",foreign_capture_groups:[21],foreign_replacer:Pn(!0),extract_arguments:On,is_standalone:!1,file_extension:"R"})]},$n=[{pattern:kn+"%R"+An(10)+"( .*)?(\n|$)",replacement:(e,t,...n)=>{let i=Tn(n,-4);return`${t}${i.outputs}rpy2.ipython.rmagic.RMagics.R("${i.content||""}", "${i.others}"${i.inputs})`},scope:"line",reverse:{pattern:Ln(),replacement:(e,...t)=>{let n=Rn(e,...t);return"%R"+n.input+n.output+n.other+n.contents},scope:"line"}},{pattern:"^%%R"+An(10)+"(\n)?([\\s\\S]*)",replacement:(e,...t)=>{let n=Tn(t,-3);return`${n.outputs}rpy2.ipython.rmagic.RMagics.R("""${n.content}""", "${n.others}"${n.inputs})`},scope:"cell",reverse:{pattern:Ln('"""',!0),replacement:(e,...t)=>{let n=Rn(e,...t);return"%%R"+n.input+n.output+n.other+"\n"+n.contents},scope:"cell"}},{pattern:kn+"%Rdevice( .*)?(\n|$)",replacement:(e,t,...n)=>`${t}rpy2.ipython.rmagic.RMagics.Rdevice("${n[0]}", "")`,scope:"line",reverse:{pattern:Ln('"',!1,"Rdevice"),replacement:(e,...t)=>{let n=Rn(e,...t);return"%Rdevice"+n.input+n.output+n.other+n.contents},scope:"line"}}];const Hn={id:o+":ipython-rpy2",requires:[c,m],activate:(e,t,n)=>{for(let e of Object.keys(zn))for(let n of zn[e])t.register(n,e);for(let e of $n)n.register(e,"python")},autoStart:!0},qn="(?:"+["-l","--connections"].join("|")+"|"+["-x","--close","-c","--creator","-p","--persist","--append"].map((e=>e+" \\w+")).join("|")+")";let Fn={python:[new p({language:"sql",pattern:`^%%sql(?: (?:(?:(?:.*?)://(?:.*))|${qn}|(?:\\w+ << )|(?:\\w+@\\w+)))?\n?((?:.+\n)?(?:[^]*))`,foreign_capture_groups:[1],is_standalone:!0,file_extension:"sql"}),new p({language:"sql",pattern:`(?:^|\n)%sql (?:(?:(?:.*?)://(?:.*))|${qn}|(.*))\n?`,foreign_capture_groups:[1],is_standalone:!1,file_extension:"sql"})]};const Nn=[Hn,{id:o+":ipython-sql",requires:[c],activate:(e,t)=>{for(let e of Object.keys(Fn))for(let n of Fn[e])t.register(n,e)},autoStart:!0},jn,Sn];class Wn{constructor(e,t){this.virtual_editor=e,this.adapter=t}markText(e,t,n){let i=this.virtual_editor.virtual_document.get_editor_at_source_line(e),s=this.virtual_editor.ce_editor_to_cm_editor.get(i),o=this.virtual_editor;return s.getDoc().markText(o.transform_from_root_to_editor(e),o.transform_from_root_to_editor(t),n)}getCursor(e){let t=this.adapter.activeEditor;if(null==t)return;let n=t.editor.getDoc().getCursor(e);return this.virtual_editor.transform_from_editor_to_root(t,n)}}class Vn{constructor(e){return this.editor_name="CodeMirrorEditor",this.isDisposed=!1,this._event_wrappers=new Map,this.adapter=e.adapter,this.virtual_document=e.virtual_document,this.console=this.adapter.console,this.change=new M.Signal(this),this.block_added_handlers=[],this.block_removed_handlers=[],this.editor_to_source_line=new Map,this.cm_editor_to_ce_editor=new Map,this.ce_editor_to_cm_editor=new Map,this._proxy=new Proxy(this,{get:function(e,t,n){return t in e?Reflect.get(e,t,n):void console.warn(`Unimplemented method ${t.toString()} for CodeMirrorVirtualEditor`)}}),this.virtual_document.update_manager.update_began.connect(this.onEditorsUpdated,this),this.virtual_document.update_manager.block_added.connect(this.save_block_position,this),this.virtual_document.update_manager.update_finished.connect((()=>{this.editor_to_source_line=this.editor_to_source_line_new}),this),this.set_event_handlers(),this._proxy}dispose(){if(!this.isDisposed){this.editor_to_source_line.clear(),this.cm_editor_to_ce_editor.clear(),this.ce_editor_to_cm_editor.clear(),this.off("change",this.emit_change);for(let[[e],t]of this._event_wrappers.entries())this.forEveryBlockEditor((n=>{n.off(e,t)}),!1);this._event_wrappers.clear(),this.disconnectBlockMonitoring(),this.virtual_document.dispose(),this.virtual_document=null,this.code_extractors=null,this.isDisposed=!0,this.forEveryBlockEditor=null,this._proxy=null}}get_cursor_position(){return this.getDoc().getCursor("end")}onEditorsUpdated(e,t){this.cm_editor_to_ce_editor.clear(),this.ce_editor_to_cm_editor.clear(),this.editor_to_source_line_new=new Map;for(let e of t){let t=e.ce_editor,n=t.editor;this.cm_editor_to_ce_editor.set(n,t),this.ce_editor_to_cm_editor.set(t,n)}}save_block_position(e,t){this.editor_to_source_line_new.set(t.block.ce_editor,t.virtual_document.last_source_line)}set_event_handlers(){this.on("change",this.emit_change.bind(this))}emit_change(e,t){this.change.emit(t)}window_coords_to_root_position(e){return this.coordsChar(e,"window")}get_token_at(e){let t=this.getTokenAt(e);return{value:t.string,offset:t.start,type:t.type}}get_cm_editor(e){return this.get_editor_at_root_line(e)}transform_virtual_to_editor(e){return this.virtual_document.transform_virtual_to_editor(e)}document_at_root_position(e){let t=e;return this.virtual_document.root.document_at_source_position(t)}root_position_to_virtual_position(e){let t=e;return this.virtual_document.root.virtual_position_at_document(t)}get_editor_at_root_position(e){return this.virtual_document.root.get_editor_at_source_line(e)}root_position_to_editor(e){return this.virtual_document.root.transform_source_to_editor(e)}on(e,t,...n){let i=(e,...n)=>{try{return t(this,...n)}catch(t){this.console.warn("CodeMirrorVirtualEditor handler (which should accept a CodeMirror Editor instance) failed",{error:t,instance:e,args:n,this:this})}};this._event_wrappers.set([e,t],i),this.forEveryBlockEditor((t=>{t.on(e,i)}),!0,(t=>{t.off(e,i)}))}off(e,t,...n){let i=this._event_wrappers.get([e,t]);this.forEveryBlockEditor((t=>{t.off(e,i)}))}find_ce_editor(e){return this.cm_editor_to_ce_editor.get(e)}transform_from_editor_to_root(e,t){if(!this.editor_to_source_line.has(e))return this.console.warn("Editor not found in editor_to_source_line map"),null;let n=this.editor_to_source_line.get(e);return Object.assign(Object.assign({},t),{line:t.line+n})}transform_from_root_to_editor(e){return this.virtual_document.transform_source_to_editor(e)}addKeyMap(e,t){}addLineClass(e,t,n){}addLineWidget(e,t,n){}addOverlay(e,t){for(let n of this.adapter.editors)n.editor.addOverlay(e,t)}addPanel(e,t){}charCoords(e,t){try{return this.get_editor_at_root_line(e).charCoords(e,t)}catch(e){return console.log(e),{bottom:0,left:0,right:0,top:0}}}coordsChar(e,t){for(let n of this.adapter.editors){let i=n.editor.coordsChar(e,t);if(1!==i.outside)return this.transform_from_editor_to_root(n,i)}}cursorCoords(e,t){return"boolean"!=typeof e?this.get_editor_at_root_line(e).cursorCoords(this.transform_from_root_to_editor(e)):{bottom:0,left:0,top:0}}get any_editor(){return this.adapter.editors[0].editor}defaultCharWidth(){return this.any_editor.defaultCharWidth()}defaultTextHeight(){return this.any_editor.defaultTextHeight()}endOperation(){for(let e of this.adapter.editors)e.editor.endOperation()}execCommand(e){for(let t of this.adapter.editors)t.editor.execCommand(e)}getDoc(){return new Wn(this,this.adapter)}get_editor_at_root_line(e){let t=this.virtual_document.root.get_editor_at_source_line(e);return this.ce_editor_to_cm_editor.get(t)}getTokenAt(e,t){if(void 0!==e)return this.get_editor_at_root_line(e).getTokenAt(this.transform_from_root_to_editor(e))}getTokenTypeAt(e){let t=this.virtual_document.get_editor_at_source_line(e);return this.ce_editor_to_cm_editor.get(t).getTokenTypeAt(this.transform_from_root_to_editor(e))}get_editor_value(e){return e.model.value.text}getWrapperElement(){return this.adapter.wrapper_element}heightAtLine(e,t,n){return 0}isReadOnly(){return!1}lineAtHeight(e,t){return 0}disconnectBlockMonitoring(){for(let e of this.block_added_handlers)this.adapter.editorAdded.disconnect(e);this.block_added_handlers=[];for(let e of this.block_removed_handlers)this.adapter.editorRemoved.disconnect(e);this.block_removed_handlers=[]}forEveryBlockEditor(e,t=!0,n=null){const i=new Set;for(let t of this.adapter.editors){let n=t.editor;i.add(n),e(n)}if(t){const t=(t,n)=>{let{editor:s}=n;if(null==s)return;let o=s.editor;i.has(o)||e(o)},s=(e,t)=>{let{editor:i}=t;if(null==i)return;let s=i.editor;n(s)};this.block_added_handlers.push(t),this.block_added_handlers.push(s),this.adapter.editorAdded.connect(t),this.adapter.editorRemoved.connect(s)}}find_editor(e){let t=this.cm_editor_to_ce_editor.get(e);return{index:this.adapter.get_editor_index(t),node:this.adapter.get_editor_wrapper(t)}}}const Un={id:o+":CodeMirrorVirtualEditor",requires:[l],activate:(e,t)=>t.registerEditorType({implementation:Vn,name:"CodeMirrorEditor",supports:ct.CodeMirrorEditor}),autoStart:!0};class Bn{constructor(){this.editorTypes=[]}registerEditorType(e){this.editorTypes.push(e)}findBestImplementation(e){for(let t of this.editorTypes)if(e.every((e=>e instanceof t.supports)))return t;return console.warn("Cold not find a VirtualEditor suitable for the provided set of editors:",e),null}}const Zn={id:o+":ILSPVirtualEditorManager",requires:[],activate:e=>new Bn,provides:l,autoStart:!0};var Kn=v.JupyterFrontEnd.IPaths;class Jn{constructor(){this.features=[],this.command_managers=[],this.command_manager_registered=new M.Signal(this)}_register(e){if(e.supersedes)for(let t of e.supersedes)this.features=this.features.filter((e=>e.id!=t));if(this.features.push(e.feature),e.feature.commands){for(let t of this.command_managers)t.add(e.feature.commands);this.command_manager_registered.connect(((t,n)=>{n.add(e.feature.commands)}))}}register(e){e.feature.settings&&e.feature.settings.ready?e.feature.settings.ready.then((()=>{e.feature.settings.composite.disable?console.log("Skipping ",e.feature.id,"as disabled"):this._register(e)})).catch(console.warn):this._register(e)}registerCommandManager(e){this.command_managers.push(e),this.command_manager_registered.emit(e)}}class Gn{constructor(e,t,n,i,s,r,a,l,c,d,h,u,_){this.app=e,this.setting_registry=t,this.palette=n,this.editor_type_manager=a,this.code_extractors_manager=l,this.code_overrides_manager=c,this.console=d,this.translator=h,this.user_console=u;const g=(h||k.nullTranslator).load("jupyterlab_lsp");this.language_server_manager=new vn({console:this.console.scope("LanguageServerManager")}),this.connection_manager=new $({language_server_manager:this.language_server_manager,console:this.console.scope("DocumentConnectionManager")});const p=new Ie({language_server_manager:this.language_server_manager,connection_manager:this.connection_manager,adapter_manager:r,translator_bundle:g});null!==_?_.registerStatusItem(o+":language-server-status",{item:p.createItem(),align:"left",rank:1,isActive:()=>r.isAnyActive()}):e.docRegistry.addWidgetExtension("Notebook",p),this.feature_manager=new Jn,this.setting_registry.load(Xn.id).then((e=>{const t=e.composite,n=t.language_servers||{};this.connection_manager.initial_configurations=n,this.connection_manager.updateConfiguration(n),this.connection_manager.updateLogging(t.logAllCommunication,t.setTrace),e.changed.connect((()=>{this.updateOptions(e)}))})).catch((e=>{d.error(e.message)})),r.registerExtension(this)}registerAdapterType(e,t){let n=new ce(Object.assign({adapter_manager:e,app:this.app,palette:this.palette,tracker:t.tracker,suffix:t.name,entry_point:t.entrypoint,console:this.console},t.context_menu));this.feature_manager.registerCommandManager(n)}get foreign_code_extractors(){return this.code_extractors_manager.registry}get code_overrides(){return this.code_overrides_manager.registry}updateOptions(e){const t=e.composite,n=t.language_servers||{};this.connection_manager.initial_configurations=n,this.connection_manager.updateConfiguration(n),this.connection_manager.updateServerConfigurations(n),this.connection_manager.updateLogging(t.logAllCommunication,t.setTrace)}}const Xn={id:o+":plugin",requires:[b.ISettingRegistry,f.ICommandPalette,w.IDocumentManager,Kn,a,l,c,m,d,k.ITranslator],optional:[y.ILoggerRegistry,x.IStatusBar],activate:(e,...t)=>new Gn(e,...t).feature_manager,provides:r,autoStart:!0},Yn=[wt,at,dn,Yt,sn,Wt,Ot,pn],Qn=[Z,Pe,R,le,oe,Zn,Un,C.COMPLETION_THEME_MANAGER,E.plugin,S.plugin,wn,Xn,...Nn,...Yn]},6988:(e,t,n)=>{"use strict";n.d(t,{_v:()=>a,EU:()=>l,nE:()=>c,Gl:()=>d,Ei:()=>h,lj:()=>g,HY:()=>m,ry:()=>v});var i=n(249),s=n(8644),o=n.n(s);const r=/^file:\/\/([^\/]+|\/[a-zA-Z](?::|%3A))/;async function a(e){return new Promise((t=>{setTimeout((()=>{t()}),e)}))}function l(e,t=35,n=50,i=(e=>e)){return new Promise((async(s,o)=>{let r=0;for(;!0!==e();){if(r+=1,-1!==t&&r>t){o("Too many retrials");break}n=i(n),await a(n)}s(e)}))}function c(e,t){const n=e.key||null;let i=!1;switch(t){case"Shift":i=e.shiftKey||"Shift"==n;break;case"Alt":i=e.altKey||"Alt"==n;break;case"AltGraph":i="AltGraph"==n;break;case"Control":i=e.ctrlKey||"Control"==n;break;case"Meta":i=e.metaKey||"Meta"==n;break;case"Accel":i=e.metaKey||"Meta"==n||e.ctrlKey||"Control"==n}return void 0!==e.getModifierState?i||e.getModifierState(t):i}class d extends Map{constructor(e,t){super(t),this.default_factory=e}get(e){return this.get_or_create(e)}get_or_create(e,...t){if(this.has(e))return super.get(e);{let n=this.default_factory(e,...t);return this.set(e,n),n}}}function h(e,t){return u(e)&&u(t)&&(e=_(e),t=_(t)),e===t||decodeURI(e)===decodeURI(t)}function u(e){return e.match(r)}function _(e){return e.replace(r,(e=>e.replace("%3A",":").toLowerCase()))}function g(e,t){return null==(t=t||i.PageConfig.getOption("rootUri"))?null:e.startsWith(t)?decodeURI(e.replace(t,"")):null}const p=(e,t)=>{const n={};let i=n;return e.forEach(((n,s)=>{i[n]={},s===e.length-1?i[n]=t:i=i[n]})),n},m=e=>{const t=[];for(let n in e){const i=p(n.split("."),e[n]);t.push(i)}return o()({},...t)};function v(e){e=e.replace(/([\\#*_[\]])/g,"\\$1");const t=document.createElement("span");return t.textContent=e,t.innerHTML.replace(/\n/g,"<br>").replace(/ {2}/g,"  ")}}}]);